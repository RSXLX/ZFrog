generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Frog {
  id               Int                 @id @default(autoincrement())
  tokenId          Int                 @unique
  name             String
  ownerAddress     String
  birthday         DateTime
  totalTravels     Int                 @default(0)
  status           FrogStatus          @default(Idle)
  xp               Int                 @default(0)
  level            Int                 @default(1)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  p0Travels        Int                 @default(0)
  interactions     FriendInteraction[] @relation("InteractionActor")
  receivedRequests Friendship[]        @relation("FriendshipAddressee")
  sentRequests     Friendship[]        @relation("FriendshipRequester")
  travelStats      FrogTravelStats?
  souvenirs        Souvenir[]
  travels          Travel[]
  badges           UserBadge[]

  @@index([ownerAddress])
}

model Travel {
  id                 Int                    @id @default(autoincrement())
  frogId             Int
   
  // 目标信息（升级）
  targetWallet       String                 // 目标钱包地址
  targetChain        ChainType              @default(ZETACHAIN_ATHENS)  // 目标链类型
  chainId            Int                    @default(7001)              // 数值型 chainId，与合约一致
  
  // 随机探索支持
  isRandom           Boolean                @default(false)             // 是否随机探索
  originalTarget     String?                                           // 原始目标（随机时为零地址）
  discoveredAt       DateTime?                                         // 地址发现时间
  
  // 时间
  startTime          DateTime
  endTime            DateTime
  duration           Int                    @default(3600)              // 旅行时长（秒），默认1小时
  
  // 状态
  status             TravelStatus           @default(Active)
  currentStage       TravelStage            @default(DEPARTING)         // 当前阶段
  progress           Int                    @default(0)                  // 进度 0-100
  
  // 跨链交易追踪
  startTxHash        String?                                           // 开始旅行的交易哈希
  completeTxHash     String?                                           // 完成旅行的交易哈希
  
  // 观察结果
  observedTxCount    Int?
  observedTotalValue String?
  
  // AI 生成内容
  journalHash        String?
  journalContent     String?
  
  // 纪念品
  souvenirId         Int?
  
  // 错误处理
  errorMessage       String?                                           // 错误信息
  
  // 时间戳
  completedAt        DateTime?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  
  // 兼容旧字段
  exploredBlock      BigInt?
  exploredTimestamp  DateTime?
  exploredSnapshot   Json?
  diary              String?
  diaryMood          DiaryMood?
  souvenirData       Json?
  addressDiscoveredAt DateTime?
  originalTargetAddress String?
  
  // 关联
  frog               Frog                   @relation(fields: [frogId], references: [id])
  souvenir           Souvenir?              @relation(fields: [souvenirId], references: [id])
  observations       WalletObservation[]
  statusMessages     TravelStatusMessage[]  // 状态消息

  @@index([frogId])
  @@index([status])
  @@index([endTime])
  @@index([targetChain])                                          // 新增索引
  @@index([exploredBlock])
  @@index([isRandom])
  @@index([addressDiscoveredAt])
}

// 新增：旅行状态消息
model TravelStatusMessage {
  id          Int         @id @default(autoincrement())
  travelId    Int
  message     String
  messageType MessageType @default(INFO)
  createdAt   DateTime    @default(now())
  
  travel      Travel      @relation(fields: [travelId], references: [id])
  
  @@index([travelId])
}

model Souvenir {
  id          Int        @id @default(autoincrement())
  tokenId     Int        @unique
  frogId      Int
  name        String
  rarity      Rarity
  metadataUri String?
  chainType   ChainType  @default(ZETACHAIN_ATHENS)                 // 来源链
  mintedAt    DateTime
  createdAt   DateTime   @default(now())
  frog        Frog       @relation(fields: [frogId], references: [id])
  travels     Travel[]

  @@index([frogId])
  @@index([chainType])                                               // 新增索引
}

model WalletObservation {
  id             Int       @id @default(autoincrement())
  travelId       Int
  walletAddress  String
  chainId        Int
  chainType      ChainType @default(ZETACHAIN_ATHENS)               // 新增
  transactions   Json
  totalTxCount   Int
  totalValueWei  String
  notableEvents  Json?
  
  // 新增：更详细的观察数据
  nativeBalance  String?                                             // 原生代币余额
  tokenBalances  Json?                                               // 代币余额
  protocols      String[]  @default([])                              // 交互的协议
  
  observedFrom   DateTime
  observedTo     DateTime
  createdAt      DateTime  @default(now())
  travel         Travel    @relation(fields: [travelId], references: [id])

  @@index([travelId])
  @@index([walletAddress])
  @@index([chainType])                                               // 新增索引
}

model SouvenirImage {
  id             String                @id @default(uuid())
  odosId         String
  travelId       String
  souvenirId     String
  souvenirType   String
  souvenirName   String
  rarity         String
  chainId        Int?
  prompt         String
  negativePrompt String?
  actualPrompt   String?
  imageUrl       String?
  ipfsHash       String?
  ipfsUrl        String?
  gatewayUrl     String?
  fileSize       Int?
  seed           Int
  stylePreset    String?
  status         ImageGenerationStatus @default(PENDING)
  retryCount     Int                   @default(0)
  errorMessage   String?
  generatedAt    DateTime?
  uploadedAt     DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  @@index([odosId])
  @@index([souvenirId])
  @@index([status])
}

model Friendship {
  id           Int                 @id @default(autoincrement())
  requesterId  Int
  addresseeId  Int
  status       FriendshipStatus    @default(Pending)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  interactions FriendInteraction[]
  addressee    Frog                @relation("FriendshipAddressee", fields: [addresseeId], references: [id])
  requester    Frog                @relation("FriendshipRequester", fields: [requesterId], references: [id])

  @@unique([requesterId, addresseeId])
  @@index([status])
}

model FriendInteraction {
  id           Int             @id @default(autoincrement())
  friendshipId Int
  actorId      Int
  type         InteractionType
  message      String?
  metadata     Json?
  createdAt    DateTime        @default(now())
  actor        Frog            @relation("InteractionActor", fields: [actorId], references: [id])
  friendship   Friendship      @relation(fields: [friendshipId], references: [id])

  @@index([friendshipId])
  @@index([actorId])
}

model TravelBadge {
  id              String          @id @default(cuid())
  code            String          @unique
  name            String
  description     String
  icon            String
  unlockType      BadgeUnlockType
  unlockCondition Json
  rarity          Int             @default(1)
  isHidden        Boolean         @default(false)
  createdAt       DateTime        @default(now())
  userBadges      UserBadge[]
}

model UserBadge {
  id                 String      @id @default(cuid())
  frogId             Int
  badgeId            String
  unlockedAt         DateTime    @default(now())
  unlockedByTravelId Int?
  badge              TravelBadge @relation(fields: [badgeId], references: [id])
  frog               Frog        @relation(fields: [frogId], references: [id])

  @@unique([frogId, badgeId])
  @@index([frogId])
}

model FrogTravelStats {
  id                   String    @id @default(cuid())
  frogId               Int       @unique
  totalTrips           Int       @default(0)
  bscTrips             Int       @default(0)
  ethTrips             Int       @default(0)
  zetaTrips            Int       @default(0)
  totalDiscoveries     Int       @default(0)
  rareFinds            Int       @default(0)
  earliestBlockVisited BigInt?
  oldestDateVisited    DateTime?
  updatedAt            DateTime  @updatedAt
  frog                 Frog      @relation(fields: [frogId], references: [id])

  @@index([frogId])
}

enum FrogStatus {
  Idle
  Traveling
  Returning
}

enum TravelStatus {
  Active      // 旅行中
  Processing  // 处理中（观察钱包、生成AI内容）
  Completed   // 已完成
  Cancelled   // 已取消
  Failed      // 失败
}

// 新增：旅行阶段
enum TravelStage {
  DEPARTING   // 出发中
  CROSSING    // 跨链穿越中
  ARRIVING    // 到达中
  EXPLORING   // 探索中
  RETURNING   // 返程中
}

// 新增：消息类型
enum MessageType {
  INFO
  DISCOVERY
  JOKE
  WARNING
  ERROR
}

enum Rarity {
  Common
  Uncommon
  Rare
  Epic
  Legendary
}

// 新增：支持的链类型（与 chains.ts 保持一致）
enum ChainType {
  BSC_TESTNET       // chainId: 97
  ETH_SEPOLIA       // chainId: 11155111
  ZETACHAIN_ATHENS  // chainId: 7001
  POLYGON_MUMBAI    // chainId: 80001 (可选扩展)
  ARBITRUM_GOERLI   // chainId: 421613 (可选扩展)
}

enum ImageGenerationStatus {
  PENDING
  GENERATING
  PROCESSING
  UPLOADING
  COMPLETED
  FAILED
}

enum FriendshipStatus {
  Pending
  Accepted
  Declined
  Blocked
}

enum InteractionType {
  Visit
  Feed
  Play
  Gift
  Message
  Travel
}

enum DiaryMood {
  HAPPY
  CURIOUS
  SURPRISED
  PEACEFUL
  EXCITED
  SLEEPY
}

enum BadgeUnlockType {
  TRIP_COUNT
  CHAIN_VISIT
  MULTI_CHAIN
  RARE_FIND
  SPECIAL
}
