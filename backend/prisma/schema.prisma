generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Frog {
  id               Int                 @id @default(autoincrement())
  tokenId          Int                 @unique
  name             String
  ownerAddress     String
  birthday         DateTime
  totalTravels     Int                 @default(0)
  status           FrogStatus          @default(Idle)
  xp               Int                 @default(0)
  level            Int                 @default(1)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  p0Travels        Int                 @default(0)
  interactions     FriendInteraction[] @relation("InteractionActor")
  receivedRequests Friendship[]        @relation("FriendshipAddressee")
  sentRequests     Friendship[]        @relation("FriendshipRequester")
  travelStats      FrogTravelStats?
  souvenirs        Souvenir[]
  travels          Travel[]
  badges           UserBadge[]

  @@index([ownerAddress])
}

model Travel {
  id                 Int                 @id @default(autoincrement())
  frogId             Int
  targetWallet       String
  chainId            Int                 @default(1)
  startTime          DateTime
  endTime            DateTime
  status             TravelStatus        @default(Active)
  observedTxCount    Int?
  observedTotalValue String?
  journalHash        String?
  journalContent     String?
  souvenirId         Int?
  completedAt        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  exploredBlock      BigInt?
  exploredTimestamp  DateTime?
  exploredSnapshot   Json?
  diary              String?
  diaryMood          DiaryMood?
  souvenirData       Json?
  isRandom           Boolean             @default(false)
  frog               Frog                @relation(fields: [frogId], references: [id])
  souvenir           Souvenir?           @relation(fields: [souvenirId], references: [id])
  observations       WalletObservation[]

  @@index([frogId])
  @@index([status])
  @@index([endTime])
  @@index([exploredBlock])
  @@index([isRandom])
}

model Souvenir {
  id          Int      @id @default(autoincrement())
  tokenId     Int      @unique
  frogId      Int
  name        String
  rarity      Rarity
  metadataUri String?
  mintedAt    DateTime
  createdAt   DateTime @default(now())
  frog        Frog     @relation(fields: [frogId], references: [id])
  travels     Travel[]

  @@index([frogId])
}

model WalletObservation {
  id            Int      @id @default(autoincrement())
  travelId      Int
  walletAddress String
  chainId       Int
  transactions  Json
  totalTxCount  Int
  totalValueWei String
  notableEvents Json?
  observedFrom  DateTime
  observedTo    DateTime
  createdAt     DateTime @default(now())
  travel        Travel   @relation(fields: [travelId], references: [id])

  @@index([travelId])
  @@index([walletAddress])
}

model SouvenirImage {
  id             String                @id @default(uuid())
  odosId         String
  travelId       String
  souvenirId     String
  souvenirType   String
  souvenirName   String
  rarity         String
  chainId        Int?
  prompt         String
  negativePrompt String?
  actualPrompt   String?
  imageUrl       String?
  ipfsHash       String?
  ipfsUrl        String?
  gatewayUrl     String?
  fileSize       Int?
  seed           Int
  stylePreset    String?
  status         ImageGenerationStatus @default(PENDING)
  retryCount     Int                   @default(0)
  errorMessage   String?
  generatedAt    DateTime?
  uploadedAt     DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  @@index([odosId])
  @@index([souvenirId])
  @@index([status])
}

model Friendship {
  id           Int                 @id @default(autoincrement())
  requesterId  Int
  addresseeId  Int
  status       FriendshipStatus    @default(Pending)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  interactions FriendInteraction[]
  addressee    Frog                @relation("FriendshipAddressee", fields: [addresseeId], references: [id])
  requester    Frog                @relation("FriendshipRequester", fields: [requesterId], references: [id])

  @@unique([requesterId, addresseeId])
  @@index([status])
}

model FriendInteraction {
  id           Int             @id @default(autoincrement())
  friendshipId Int
  actorId      Int
  type         InteractionType
  message      String?
  metadata     Json?
  createdAt    DateTime        @default(now())
  actor        Frog            @relation("InteractionActor", fields: [actorId], references: [id])
  friendship   Friendship      @relation(fields: [friendshipId], references: [id])

  @@index([friendshipId])
  @@index([actorId])
}

model TravelBadge {
  id              String          @id @default(cuid())
  code            String          @unique
  name            String
  description     String
  icon            String
  unlockType      BadgeUnlockType
  unlockCondition Json
  rarity          Int             @default(1)
  isHidden        Boolean         @default(false)
  createdAt       DateTime        @default(now())
  userBadges      UserBadge[]
}

model UserBadge {
  id                 String      @id @default(cuid())
  frogId             Int
  badgeId            String
  unlockedAt         DateTime    @default(now())
  unlockedByTravelId Int?
  badge              TravelBadge @relation(fields: [badgeId], references: [id])
  frog               Frog        @relation(fields: [frogId], references: [id])

  @@unique([frogId, badgeId])
  @@index([frogId])
}

model FrogTravelStats {
  id                   String    @id @default(cuid())
  frogId               Int       @unique
  totalTrips           Int       @default(0)
  bscTrips             Int       @default(0)
  ethTrips             Int       @default(0)
  zetaTrips            Int       @default(0)
  totalDiscoveries     Int       @default(0)
  rareFinds            Int       @default(0)
  earliestBlockVisited BigInt?
  oldestDateVisited    DateTime?
  updatedAt            DateTime  @updatedAt
  frog                 Frog      @relation(fields: [frogId], references: [id])

  @@index([frogId])
}

enum FrogStatus {
  Idle
  Traveling
  Returning
}

enum TravelStatus {
  Active
  Processing
  Completed
  Cancelled
  Failed
}

enum Rarity {
  Common
  Uncommon
  Rare
  Epic
  Legendary
}

enum ImageGenerationStatus {
  PENDING
  GENERATING
  PROCESSING
  UPLOADING
  COMPLETED
  FAILED
}

enum FriendshipStatus {
  Pending
  Accepted
  Declined
  Blocked
}

enum InteractionType {
  Visit
  Feed
  Play
  Gift
  Message
  Travel
}

enum DiaryMood {
  HAPPY
  CURIOUS
  SURPRISED
  PEACEFUL
  EXCITED
  SLEEPY
}

enum BadgeUnlockType {
  TRIP_COUNT
  CHAIN_VISIT
  MULTI_CHAIN
  RARE_FIND
  SPECIAL
}
