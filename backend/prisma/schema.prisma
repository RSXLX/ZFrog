generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Frog {
  id           Int        @id @default(autoincrement())
  tokenId      Int        @unique
  name         String
  ownerAddress String
  birthday     DateTime
  totalTravels Int        @default(0)
  status       FrogStatus @default(Idle)
  xp           Int        @default(0)
  level        Int        @default(1)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  souvenirs    Souvenir[]
  travels      Travel[]
  
  // 好友关系
  sentRequests     Friendship[]     @relation("FriendshipRequester")
  receivedRequests Friendship[]     @relation("FriendshipAddressee")
  interactions     FriendInteraction[] @relation("InteractionActor")

  @@index([ownerAddress])
}

model Travel {
  id                 Int                 @id @default(autoincrement())
  frogId             Int
  targetWallet       String
  chainId            Int                 @default(1) // Default Ethereum Mainnet
  startTime          DateTime
  endTime            DateTime
  status             TravelStatus        @default(Active)
  observedTxCount    Int?
  observedTotalValue String?
  journalHash        String?
  journalContent     String?
  souvenirId         Int?
  completedAt        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  frog               Frog                @relation(fields: [frogId], references: [id])
  souvenir           Souvenir?           @relation(fields: [souvenirId], references: [id])
  observations       WalletObservation[]

  @@index([frogId])
  @@index([status])
  @@index([endTime])
}

model Souvenir {
  id          Int      @id @default(autoincrement())
  tokenId     Int      @unique
  frogId      Int
  name        String
  rarity      Rarity
  metadataUri String?
  mintedAt    DateTime
  createdAt   DateTime @default(now())
  frog        Frog     @relation(fields: [frogId], references: [id])
  travels     Travel[]

  @@index([frogId])
}

model WalletObservation {
  id            Int      @id @default(autoincrement())
  travelId      Int
  walletAddress String
  chainId       Int
  transactions  Json
  totalTxCount  Int
  totalValueWei String
  notableEvents Json?
  observedFrom  DateTime
  observedTo    DateTime
  createdAt     DateTime @default(now())
  travel        Travel   @relation(fields: [travelId], references: [id])

  @@index([travelId])
  @@index([walletAddress])
}

enum FrogStatus {
  Idle
  Traveling
  Returning
}

enum TravelStatus {
  Active
  Processing
  Completed
  Cancelled
  Failed
}

enum Rarity {
  Common
  Uncommon
  Rare
  Epic
  Legendary
}

enum ImageGenerationStatus {
  PENDING
  GENERATING
  PROCESSING
  UPLOADING
  COMPLETED
  FAILED
}

model SouvenirImage {
  id             String                @id @default(uuid())
  odosId         String
  travelId       String
  souvenirId     String
  souvenirType   String
  souvenirName   String
  rarity         String
  chainId        Int?
  prompt         String
  negativePrompt String?
  actualPrompt   String?
  imageUrl       String?
  ipfsHash       String?
  ipfsUrl        String?
  gatewayUrl     String?
  fileSize       Int?
  seed           Int
  stylePreset    String?
  status         ImageGenerationStatus @default(PENDING)
  retryCount     Int                   @default(0)
  errorMessage   String?
  generatedAt    DateTime?
  uploadedAt     DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  @@index([odosId])
  @@index([souvenirId])
  @@index([status])
}


model Friendship {
  id         Int            @id @default(autoincrement())
  requesterId Int
  addresseeId Int
  status     FriendshipStatus @default(Pending)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  
  requester  Frog           @relation("FriendshipRequester", fields: [requesterId], references: [id])
  addressee  Frog           @relation("FriendshipAddressee", fields: [addresseeId], references: [id])
  
  // 好友间的互动记录
  interactions FriendInteraction[]
  
  @@unique([requesterId, addresseeId])
  @@index([status])
}

model FriendInteraction {
  id           Int               @id @default(autoincrement())
  friendshipId Int
  actorId      Int               // 发起互动的青蛙ID
  type         InteractionType
  message      String?
  metadata     Json?             // 额外的互动数据，如礼物信息等
  createdAt    DateTime          @default(now())
  
  friendship   Friendship        @relation(fields: [friendshipId], references: [id])
  actor        Frog              @relation("InteractionActor", fields: [actorId], references: [id])
  
  @@index([friendshipId])
  @@index([actorId])
}

enum FriendshipStatus {
  Pending     // 待确认
  Accepted    // 已接受
  Declined    // 已拒绝
  Blocked     // 已拉黑
}

enum InteractionType {
  Visit       // 拜访
  Feed        // 喂食
  Play        // 玩耍
  Gift        // 送礼
  Message     // 留言
  Travel      // 一起旅行
}
