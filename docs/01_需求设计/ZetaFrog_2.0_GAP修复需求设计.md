---
status: 已审核
version: 1.0
last_updated: 2026-02-04
reviewer: 用户
---

# ZetaFrog 2.0 GAP 修复需求设计

> 基于 `system_gap_analysis.md` 的缺口分析，制定系统修复的完整需求规格。

---

## 一、需求背景

### 1.1 问题陈述

当前系统处于 V1.5 状态，与 `ZetaFrog_2.0_Unified_PRD.md` 定义的功能目标存在 **45% 的功能缺口**，主要体现在：

1. **基础设施**：跨链纪念品未真正上链，存在配置硬编码风险。
2. **资产韧性**：缺乏冬眠/唤醒机制，用户流失不可挽回。
3. **基因博弈**：繁殖算法过于简单，缺乏孟德尔显隐性深度。
4. **社交深度**：仅有好友点对点交互，缺乏家族 DAO 组织性玩法。

### 1.2 修复目标

- **全量修复**：依次完成 D → A → C → B 四个模块的功能补全。
- **合约升级**：采用 UUPS 代理机制升级 `OmniTravel` 合约。

---

## 二、功能需求列表

### 模块 D: 基础设施修复 (Phase 1)

| #   | 功能                    | 优先级 | 描述                                                                               |
| --- | ----------------------- | ------ | ---------------------------------------------------------------------------------- |
| D1  | 跨链纪念品上链          | P0     | 修改 `OmniTravel` 合约，在 `markTravelCompleted` 中调用 `SouvenirNFT.mintSouvenir` |
| D2  | 后端 Souvenir Mint 调用 | P0     | `omni-travel.service.ts` 在完成跨链旅行时调用合约 Mint 函数                        |
| D3  | 统一地址配置            | P1     | 移除 `omni-travel.service.ts` 中的硬编码 Fallback 地址，强制使用 `config`          |
| D4  | ABI 补全                | P2     | `config/contracts.ts` 补全 `name()`/`symbol()` 等 ERC721 标准读取函数              |

### 模块 A: 资产韧性系统 (Phase 2)

| #   | 功能             | 优先级 | 描述                                                                                        |
| --- | ---------------- | ------ | ------------------------------------------------------------------------------------------- |
| A1  | Frog Schema 扩展 | P0     | 新增 `hibernationStatus` (ACTIVE/DROWSY/SLEEPING) 枚举字段                                  |
| A2  | 冬眠检测逻辑     | P0     | `status-cron.job.ts` 每小时检测 `lastInteractedAt`，超过 72h 进入 DROWSY，96h 进入 SLEEPING |
| A3  | 唤醒费用计算     | P0     | 实现 `calculateRevivalCost(level, sleepDays)` 公式                                          |
| A4  | 好友祈福功能     | P1     | 好友消耗活力为冬眠青蛙祈福，每人减免 15%，上限 60%                                          |
| A5  | 冬眠 UI 提示     | P1     | 前端在青蛙状态为 DROWSY/SLEEPING 时显示警告/唤醒按钮                                        |

### 模块 C: 基因博弈系统 (Phase 3)

| #   | 功能              | 优先级 | 描述                                                                                 |
| --- | ----------------- | ------ | ------------------------------------------------------------------------------------ |
| C1  | 基因数据结构      | P0     | `Frog.genes` 改为结构化 JSON: `{ skin: { dom: 'green', rec: 'gold' }, eyes: {...} }` |
| C2  | 孟德尔遗传算法    | P0     | 重写 `calculateOffspringGenes`，使用 Punnett Square 计算子代基因型                   |
| C3  | 表现型解析        | P0     | 根据显隐性规则计算 `phenotype`（显性表达 or 隐性返祖）                               |
| C4  | G-Factor 全局调节 | P1     | 新建 `GlobalConfig` 表，每日根据产销比更新商店税率                                   |

### 模块 B: 家族 DAO 系统 (Phase 4)

| #   | 功能          | 优先级 | 描述                                                     |
| --- | ------------- | ------ | -------------------------------------------------------- |
| B1  | Family Schema | P0     | 新建 `Family` 表（名称、族长、成员、图腾等级、创建时间） |
| B2  | 家族创建      | P0     | 消耗 $ZETA + 高等级青蛙创建家族，分配族长                |
| B3  | 图腾共建      | P1     | 成员每日"浇水"消耗活力，累积升级家族图腾                 |
| B4  | 周常任务      | P1     | 家族全员累计旅行里程达标，发放共享宝箱                   |
| B5  | 救援功能      | P2     | 完善 `RescueRequest` 业务逻辑（好友支付 Gas 救援）       |

---

## 三、用户场景 (User Stories)

### US-D1: 跨链纪念品上链

**作为**一个完成跨链旅行的用户，
**我希望**在旅行结束时收到链上铸造的 SouvenirNFT，
**以便**我可以在钱包中查看和交易我的纪念品。

### US-A1: 冬眠唤醒

**作为**一个回归的流失用户，
**我希望**支付 $LILY 唤醒我的冬眠青蛙，
**以便**我可以继续游戏而不是资产归零。

### US-C1: 稀有返祖

**作为**一个育种玩家，
**我希望**通过配对两只携带隐性金色基因的青蛙，有 25% 概率获得金色传说皮肤子代，
**以便**我可以通过策略博弈获取高价值青蛙。

### US-B1: 家族协作

**作为**一个家族成员，
**我希望**每日浇水升级家族图腾并获得全员 Buff，
**以便**我可以与家族成员建立共同利益连接。

---

## 四、假设与依赖

### 假设

1. `OmniTravelUpgradeable.sol` 支持 UUPS 升级，无需重新部署代理地址。
2. `SouvenirNFT` 合约已部署且 Relayer 有 Mint 权限。
3. 前端可在 1 周内适配冬眠状态 UI。

### 依赖

1. 合约升级需要 Deployer 私钥和 ZetaChain Athens 测试网 Gas。
2. G-Factor 算法依赖全服交易数据统计 (需确认数据源)。

---

## 五、边界条件

1. **冬眠期间**：青蛙不可旅行、不可繁殖、不产出任何收益。
2. **唤醒费用上限**：设置 `MAX_REVIVAL_COST` 防止费用无限增长。
3. **家族成员上限**：初期限制 5-20 人。
4. **基因返祖概率**：严格遵循孟德尔 25% 概率，不做额外调整。

---

## 六、验收标准概览

| 模块 | 验收标准                                                 |
| :--- | :------------------------------------------------------- |
| D    | 跨链旅行完成后，可在区块浏览器看到 `SouvenirMinted` 事件 |
| A    | 青蛙 96h 未交互自动进入 SLEEPING 状态，支付费用可唤醒    |
| C    | 两只 `rec: gold` 青蛙繁殖，子代有约 25% 概率表现金色     |
| B    | 可创建家族、邀请成员、每日浇水升级图腾                   |

---

## 七、多角色讨论记录

### 🎭 产品经理 (PM)

> 修复优先级明确：基建 > 韧性 > 博弈 > 社交。建议先稳定"资产安全"相关功能后再扩展社交玩法。

### 🏗️ 架构师 (Architect)

> 合约升级是正确选择。`SouvenirNFT.mintSouvenir` 应在 `markTravelCompleted` 的同一事务内调用，确保原子性。后端补丁方案存在"漏 Mint"风险。

### 🧪 测试工程师 (QA)

> 冬眠逻辑需覆盖边界：正好 72h、正好 96h、跨链旅行期间不计冬眠时间。基因算法需大量随机测试验证概率分布。

### 👤 用户代言人 (Advocate)

> 唤醒费用不能太高，否则用户宁愿弃号。建议设置 `MAX_COST = 2000 $LILY`。好友祈福是很棒的社交回流设计。

---

## 八、变更记录

| 日期       | 版本 | 内容         |
| ---------- | ---- | ------------ |
| 2026-02-04 | 1.0  | 初始需求设计 |
