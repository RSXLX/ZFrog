---
status: 待审核
version: 1.0
last_updated: 2026-01-15
reviewer: 用户
---

# 徽章空投系统需求设计

> 本文档定义徽章解锁空投奖励功能和管理员控制台的需求设计。

---

## 一、模块概述

### 1.1 功能目标
1. **徽章解锁空投**：用户解锁徽章后，自动或手动触发代币空投奖励
2. **管理员控制台**：管理员可增减徽章、设置空投奖励金额
3. **统一发放机制**：使用后端配置的私钥地址统一发放奖励

### 1.2 用户价值
- 激励用户完成成就目标
- 增加游戏粘性和参与感
- 构建完整的奖励闭环

---

## 二、内部讨论记录

### 讨论主题：徽章空投系统设计方案

**产品经理**：
核心目标是提升用户留存率和活跃度。徽章解锁后发放空投奖励可以：
1. 即时满足感 - 解锁徽章立即获得代币
2. 长期激励 - 稀有徽章对应更高奖励
3. 建议奖励类型以 ZETA 代币为主，与项目生态一致

**架构师**：
关于技术方案有几个关键决策点：
1. **发放时机**：解锁时立即发放 vs 用户手动领取
   - 立即发放：用户体验好，但需要注意 Gas 费用和失败处理
   - 手动领取：用户控制权大，可以批量领取节省 Gas
   - **建议**：采用「自动记录 + 手动领取」模式，解锁时记录奖励，用户可随时领取
   
2. **私钥安全**：后端私钥需妥善保管
   - 必须使用环境变量，禁止硬编码
   - 建议使用专用的空投发放地址，不与其他功能混用
   - 定期监控发放地址余额

3. **失败重试**：交易失败需有重试机制
   - 记录发放状态，支持人工干预

**测试工程师**：
边界条件和异常场景：
1. 同一徽章重复解锁如何处理？→ UserBadge 已有唯一约束，不会重复
2. 发放地址余额不足怎么办？→ 需要预检查余额，不足时标记待发放
3. 交易上链失败？→ 需要重试机制或人工干预
4. 管理员误操作删除了有用户已解锁的徽章？→ 建议软删除，不影响已解锁记录

**用户代言人**：
使用体验考量：
1. 解锁通知要明显，突出奖励金额
2. 领取流程要简单，一键操作
3. 历史记录要清晰，可追溯

**最终决策**：
1. 采用「自动记录 + 手动领取」模式
2. 徽章表新增 `airdropAmount` 字段
3. 新增 `BadgeReward` 表记录待领取/已领取奖励
4. 管理员控制台使用前端页面 + API 实现
5. 使用环境变量配置的私钥地址发放

---

## 三、用户场景

### 3.1 用户解锁徽章并领取奖励

**场景描述**：用户完成旅行后解锁了"跨链旅行者"徽章，可领取 0.01 ZETA 奖励

**操作流程**：
1. 用户完成跨链旅行
2. 系统检查并解锁徽章
3. 系统创建待领取奖励记录
4. 用户进入徽章页面，看到"可领取奖励"提示
5. 用户点击"领取奖励"按钮
6. 后端创建交易并发送
7. 用户收到 ZETA 代币

### 3.2 管理员创建徽章

**场景描述**：管理员需要添加新的限定徽章

**操作流程**：
1. 管理员登录后台
2. 进入徽章管理页面
3. 点击"新增徽章"
4. 填写徽章信息（名称、图标、解锁条件、空投金额）
5. 保存并生效

### 3.3 管理员调整空投金额

**场景描述**：活动期间需要临时提高某徽章的奖励

**操作流程**：
1. 管理员进入徽章管理
2. 找到目标徽章，点击编辑
3. 修改空投金额
4. 保存生效（仅影响新解锁用户）

---

## 四、功能需求

### 4.1 数据库变更

#### 4.1.1 TravelBadge 表新增字段
```prisma
model TravelBadge {
  // ... 现有字段 ...
  airdropAmount   String?         // 空投金额 (wei 字符串)
  airdropEnabled  Boolean         @default(false)  // 是否启用空投
}
```

#### 4.1.2 新增 BadgeReward 表
```prisma
model BadgeReward {
  id              String          @id @default(cuid())
  userBadgeId     String          @unique           // 关联已解锁徽章
  ownerAddress    String                            // 接收地址
  amount          String                            // 奖励金额 (wei)
  status          RewardStatus    @default(PENDING) // 状态
  txHash          String?                           // 发放交易哈希
  claimedAt       DateTime?                         // 领取时间
  failReason      String?                           // 失败原因
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  userBadge       UserBadge       @relation(fields: [userBadgeId], references: [id])
  
  @@index([ownerAddress])
  @@index([status])
}

enum RewardStatus {
  PENDING     // 待领取
  PROCESSING  // 处理中
  COMPLETED   // 已完成
  FAILED      // 失败
}
```

### 4.2 后端 API

#### 4.2.1 用户 API
| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/badges/rewards` | GET | 获取用户待领取奖励列表 |
| `/api/badges/rewards/claim` | POST | 领取奖励 |
| `/api/badges/rewards/claim-all` | POST | 批量领取所有奖励 |

#### 4.2.2 管理员 API
| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/admin/badges` | GET | 获取所有徽章 |
| `/api/admin/badges` | POST | 创建徽章 |
| `/api/admin/badges/:id` | PUT | 更新徽章 |
| `/api/admin/badges/:id` | DELETE | 删除徽章（软删除） |
| `/api/admin/badges/:id/airdrop` | PUT | 设置空投配置 |
| `/api/admin/rewards/stats` | GET | 获取发放统计 |
| `/api/admin/rewards/retry/:id` | POST | 重试失败的发放 |

### 4.3 前端页面

#### 4.3.1 用户端
- 徽章页面增加"领取奖励"按钮
- 显示待领取奖励数量和金额
- 领取成功/失败的 Toast 提示

#### 4.3.2 管理端
- 徽章列表页（含搜索、筛选）
- 徽章编辑表单
- 发放统计仪表盘
- 失败记录列表（支持重试）

### 4.4 空投发放服务

```typescript
// 配置
AIRDROP_PRIVATE_KEY=xxx      // 发放私钥
AIRDROP_MIN_BALANCE=0.5      // 发放地址最低余额警告

// 核心功能
- claimReward(rewardId): 处理单个领取
- claimAllRewards(ownerAddress): 批量领取
- checkAirdropBalance(): 检查发放地址余额
- retryFailedReward(rewardId): 重试失败的发放
```

---

## 五、边界条件

| 场景 | 处理方式 |
|------|----------|
| 徽章无空投配置 | 解锁时不创建 BadgeReward 记录 |
| 发放地址余额不足 | 标记为 FAILED，记录原因，需管理员补充余额后重试 |
| 交易失败 | 标记为 FAILED，支持重试 |
| 重复领取 | userBadgeId 唯一约束防止重复 |
| 删除已解锁徽章 | 软删除，保留 UserBadge 和 BadgeReward 记录 |

---

## 六、安全考量

1. **私钥安全**：仅通过环境变量配置，禁止日志打印
2. **管理员鉴权**：管理 API 需验证管理员身份（建议签名验证）
3. **限流保护**：领取 API 需要限流，防止刷取
4. **金额校验**：空投金额上限校验，防止误设超大金额

---

## 七、假设清单

| 假设 | 待确认 |
|------|--------|
| 空投代币为 ZETA（原生代币） | ✅ 已确认 |
| 管理员采用特定地址签名鉴权 | ⏳ 待确认：是否需要更复杂的权限系统？ |
| 空投金额以 wei 为单位存储 | ✅ 已确认 |

---

## 八、变更记录

| 日期 | 版本 | 内容 |
|------|------|------|
| 2026-01-15 | 1.0 | 初始需求设计 |

---
