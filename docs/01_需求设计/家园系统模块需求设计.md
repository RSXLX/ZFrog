---
status: 待审核
version: 2.0
last_updated: 2026-01-14
reviewer: 用户
---

# 家园系统模块需求设计

## 一、模块概述

家园系统是青蛙的专属空间，玩家可以装饰家园、放置家具、种植植物，打造个性化环境。V2.0 版本引入格栅系统、环境影响因子和社交深度化功能。

---

## 二、用户场景

### 2.1 家园管理
- 查看和进入自己的家园
- **【V2.0】** 切换浏览模式/装修模式
- **【V2.0】** 网格对齐放置家具（Snap-to-grid）
- 装饰家园环境

### 2.2 装饰收集
- 购买或获取装饰品
- 管理装饰品库存
- 解锁特殊装饰
- **【V2.0】** 装饰品带有 Buff 效果

### 2.3 家园互动
- 邀请好友参观家园
- 给好友家园点赞
- 互赠装饰品
- **【V2.0】** 拜访好友家园寻宝
- **【V2.0】** 留言板互动

### 2.4 【V2.0】离线收益
- 根据家园舒适度计算离线期间的幸运值/资源产出
- 登录时领取离线收益

---

## 三、功能需求

### 3.1 后端功能

| 功能 | 描述 | 版本 |
|------|------|------|
| 家园数据 | 存储家园布局和装饰 | V1.0 |
| 装饰系统 | 管理装饰品库存 | V1.0 |
| 参观记录 | 记录家园访问 | V1.0 |
| 格栅系统 | 网格坐标存储与冲突检测 | **V2.0** |
| 编辑锁 | 防止多窗口同时编辑 | **V2.0** |
| 舒适度计算 | 根据装饰品计算家园舒适度 | **V2.0** |
| 每日寻宝 | 好友家园随机掉落奖励 | **V2.0** |
| 离线收益 | 根据舒适度计算离线产出 | **V2.0** |

### 3.2 前端功能

| 功能 | 描述 | 版本 |
|------|------|------|
| 家园渲染 | 渲染家园场景 | V1.0 |
| 拖放编辑 | 拖放式装饰编辑 | V1.0 |
| 装饰商店 | 浏览和购买装饰 | V1.0 |
| 网格覆盖层 | 显示网格线和放置提示 | **V2.0** |
| 多态编辑模式 | 浏览/装修模式切换 | **V2.0** |
| 预检测反馈 | 拖拽时实时显示可放置区域 | **V2.0** |
| 天气动画 | 下雨/下雪时装饰品特殊动画 | **V2.0** |

---

## 四、数据结构

### 4.1 家园布局（V2.0 增强）

```typescript
interface RoomLayout {
  id: string;
  frogId: number;
  sceneType: 'yard' | 'indoor';
  gridCols: number;       // 网格列数 (默认 12)
  gridRows: number;       // 网格行数 (默认 10)
  comfortScore: number;   // 舒适度分数
  editLock: string | null; // 编辑锁 (sessionId:expiry)
  version: number;
  items: PlacedItem[];
}
```

### 4.2 放置物品（V2.0 增强）

```typescript
interface PlacedItem {
  id: string;
  gridX: number;      // 网格坐标 X (0 ~ gridCols-1)
  gridY: number;      // 网格坐标 Y (0 ~ gridRows-1)
  scale: number;
  rotation: number;   // 0, 90, 180, 270
  zIndex: number;
  state: 'normal' | 'rain' | 'snow'; // 天气状态
}
```

### 4.3 装饰品定义（V2.0 增强）

```typescript
interface Decoration {
  id: string;
  name: string;
  type: 'FURNITURE' | 'PLANT' | 'FLOORING' | 'WALLPAPER' | 'SOUVENIR_DISPLAY';
  assetUrl: string;
  gridWidth: number;   // 占用网格宽度
  gridHeight: number;  // 占用网格高度
  buffType?: string;   // Buff 类型
  buffValue?: number;  // Buff 数值
  weatherAnim?: string; // 天气动画 ID
  rarity: number;      // 稀有度 1-5
}
```

### 4.4 【V2.0】每日寻宝

```typescript
interface DailyTreasure {
  id: string;
  hostFrogId: number;   // 宝藏所在家园
  visitorId: number;    // 发现者
  rewardType: 'token' | 'material' | 'decoration';
  rewardId?: string;
  rewardAmount: number;
  foundAt: Date;
}
```

### 4.5 【V2.0】离线收益

```typescript
interface OfflineBonus {
  id: string;
  frogId: number;
  offlineHours: number;
  comfortScore: number;
  bonusType: 'luck' | 'resource';
  bonusValue: number;
  claimedAt?: Date;
}
```

---

## 五、接口依赖

| 模块 | 文件 | 说明 |
|------|------|------|
| 后端路由 | `homestead.routes.ts` | 家园主 API |
| 后端路由 | `garden.routes.ts` | 花园访问 API |
| 服务 | `decoration.service.ts` | 装饰品服务 |
| 服务 | `comfort.service.ts` | **【V2.0】** 舒适度计算 |
| 服务 | `treasure.service.ts` | **【V2.0】** 寻宝服务 |
| 前端组件 | `components/garden/` | 家园相关组件 |
| 前端组件 | `components/garden/GridOverlay.tsx` | **【V2.0】** 网格覆盖层 |
| 前端 Hook | `hooks/useGridEditor.ts` | **【V2.0】** 网格编辑 Hook |

---

## 六、边界条件

### 6.1 基础边界
- 装饰品放置数量上限（每场景最多 50 个）
- 装饰品位置碰撞检测
- 家园主题兼容性

### 6.2 【V2.0】格栅系统边界
- 网格尺寸：12 列 × 10 行
- 多格物品不能超出网格边界
- 旋转后重新计算占用格

### 6.3 【V2.0】资产校验
- 编辑锁有效期：5 分钟
- 编辑锁过期自动释放
- 同一用户不同窗口互斥

### 6.4 【V2.0】寻宝限制
- 每位访客每天在同一家园只能寻宝 1 次
- 宝藏每日 0:00 刷新
- 需好友关系才能寻宝

---

## 七、【V2.0】寻宝奖励设计

### 7.1 奖励类型与概率

| 奖励类型 | 概率 | 内容 | 备注 |
|----------|------|------|------|
| 代币 | 50% | 1-10 ZETA | 小额激励 |
| 素材 | 35% | 食物/物资 × 1-3 | 用于喂养青蛙 |
| 装饰品 | 15% | 随机普通装饰 | 稀有度 1-2 |

### 7.2 寻宝流程

```
访问好友家园
      ↓
检查今日是否已寻宝
      ↓
    ┌─ 是 → 显示"明日再来"
    │
    └─ 否 → 显示寻宝按钮
              ↓
          点击寻宝
              ↓
          随机生成奖励
              ↓
          播放开宝动画
              ↓
          奖励入账
```

---

## 八、变更记录

| 日期 | 版本 | 内容 |
|------|------|------|
| 2026-01-13 | 1.0 | 初始需求设计 |
| 2026-01-14 | 2.0 | V2.0 增强：格栅系统、多态编辑、环境因子、寻宝、离线收益 |

---
