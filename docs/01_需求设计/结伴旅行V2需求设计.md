---
status: 已审核
version: 1.0
last_updated: 2026-01-15
reviewer: 用户
---

# 结伴旅行 V2.0 - 跨链版本需求设计

> 结伴旅行升级为使用跨链合约进行链上探寻，由发起人支付 gas，真正实现两只青蛙的链上结伴冒险。

---

## 一、背景与目标

### 1.1 当前状态

| 项目 | 现状 |
|------|------|
| 单人跨链旅行 | ✅ 已实现（`OmniTravel.sol` → `startCrossChainTravel()`） |
| 结伴旅行 | ⚠️ 纯后端实现（无链上交互，无 gas 费） |
| 合约结构 | ⚠️ `GroupCrossChainTravel` 已定义但未实现 |

### 1.2 升级目标

1. **链上结伴**：两只青蛙的结伴旅行通过跨链合约发起
2. **发起人付费**：Leader 支付两只青蛙的探索 gas（干粮）
3. **链上探索**：结伴旅行期间，两只青蛙同步进行链上探索
4. **社交增强**：完成后增加友情值，解锁双人徽章

---

## 二、角色内部讨论

### 讨论主题：结伴旅行跨链方案

**产品经理**：
- 用户价值：证明两只青蛙真正一起冒险，链上可验证
- 需考虑 gas 费用显示，用户理解成本

**架构师**：
- 复用现有 `OmniTravel.sol` 的跨链机制
- 新增 `startGroupCrossChainTravel()` 函数
- 干粮费 = 2 × 单人干粮 (两只青蛙同时探索)
- 考虑只锁定 Leader NFT，Companion 仅状态更新

**测试工程师**：
- 边界：Leader 和 Companion 都必须 Idle
- 边界：Companion 的青蛙所有者不是发起交易者，需确认已是好友
- 异常：跨链失败时两只青蛙都需解锁

**最终决策**：
1. 新增合约函数 `startGroupCrossChainTravel(leaderTokenId, companionTokenId, targetChainId, duration)`
2. 只锁定 Leader NFT，Companion 在数据库标记为 Traveling
3. 探索时两只青蛙共享探索记录，获得双倍发现
4. 干粮费按 1.5 倍计算（节省社交成本）

---

## 三、用户场景

### 3.1 正常流程

```
┌───────────────┐     ┌──────────────────┐     ┌─────────────────┐
│ 1. 选择好友   │ ──▶ │ 2. 确认旅行参数  │ ──▶ │ 3. 发起链上交易 │
│   (Idle)      │     │   (目标链/时长)  │     │  (Leader付费)   │
└───────────────┘     └──────────────────┘     └─────────────────┘
                                                       │
       ┌───────────────────────────────────────────────┘
       ▼
┌───────────────┐     ┌──────────────────┐     ┌─────────────────┐
│ 4. 两蛙锁定  │ ──▶ │ 5. 结伴探索中   │ ──▶ │ 6. 完成返回    │
│  状态同步     │     │ 每30s双倍发现   │     │  友情值+XP      │
└───────────────┘     └──────────────────┘     └─────────────────┘
```

### 3.2 用户操作步骤

| 步骤 | 操作 | 系统响应 |
|------|------|----------|
| 1 | 在好友列表选择结伴按钮 | 显示结伴旅行模态框 |
| 2 | 选择目标链和旅行时长 | 计算干粮费（1.5×单人） |
| 3 | 确认并发起交易 | 唤起钱包签名 |
| 4 | 交易确认 | 两只青蛙状态变为 Traveling |
| 5 | 旅行进行中 | 页面显示双人探索动画+共享发现 |
| 6 | 旅行完成 | 两只青蛙获得 XP，友情值 +5 |

### 3.3 异常场景

| 场景 | 处理方式 |
|------|----------|
| Companion 不在 Idle 状态 | 提示用户等待 Companion 结束当前旅行 |
| 两只不是好友 | 提示需要先建立好友关系 |
| 干粮不足 | 提示充值干粮 |
| 跨链消息失败 | 两只青蛙都解锁，退还剩余干粮 |
| Leader 紧急返回 | 同时强制返回 Companion |

---

## 四、功能需求

### 4.1 合约层

| 功能 | 说明 | 优先级 |
|------|------|--------|
| `startGroupCrossChainTravel()` | 发起结伴跨链旅行 | P0 |
| `completeGroupTravel()` | 完成结伴旅行，解锁两只青蛙 | P0 |
| `emergencyGroupReturn()` | 紧急返回，同时解锁两只青蛙 | P1 |
| `GroupCrossChainTravelStarted` 事件 | 链上事件追踪 | P0 |

### 4.2 后端层

| 功能 | 说明 | 优先级 |
|------|------|--------|
| POST `/api/group-travel/start` | 发起结伴跨链旅行 | P0 |
| 监听 `GroupCrossChainTravelStarted` | 创建 Travel + GroupTravel 记录 | P0 |
| 双人探索循环 | 每 30s 为两只青蛙生成探索记录 | P0 |
| 完成处理 | 更新两只青蛙状态 + 友情值 + 徽章 | P0 |

### 4.3 前端层

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 结伴旅行模态框 V2 | 添加目标链选择和 gas 估算 | P0 |
| 链上交易发起 | 调用 `startGroupCrossChainTravel()` | P0 |
| 双人旅行页面 | 显示两只青蛙同时探索 | P1 |
| 双人探索动画 | 两蛙并行探索可视化 | P2 |

---

## 五、数据规格

### 5.1 合约事件

```solidity
event GroupCrossChainTravelStarted(
    uint256 indexed leaderTokenId,
    uint256 indexed companionTokenId,
    address indexed leaderOwner,
    address companionOwner,
    uint256 targetChainId,
    bytes32 messageId,
    uint64 startTime,
    uint64 maxDuration
);
```

### 5.2 数据库扩展

`GroupTravel` 表新增字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| `isCrossChain` | Boolean | 是否跨链结伴旅行 |
| `crossChainMessageId` | String? | 跨链消息 ID |
| `targetChainId` | Int? | 目标链 ID |
| `provisionsUsed` | String? | 消耗的干粮 (wei) |

---

## 六、Gas 估算

### 6.1 干粮费计算

```typescript
// 结伴旅行干粮 = 单人干粮 × 1.5 (社交优惠)
const groupProvisions = singleProvisions * 1.5;

// 单人干粮公式 (来自 OmniTravel.sol)
// MIN_PROVISIONS + (durationHours * provisionsFeePerHour)
// 0.01 ZETA + (小时数 * 0.005 ZETA)
```

### 6.2 示例

| 时长 | 单人干粮 | 双人干粮 (1.5×) |
|------|----------|-----------------|
| 1 小时 | 0.015 ZETA | 0.0225 ZETA |
| 3 小时 | 0.025 ZETA | 0.0375 ZETA |
| 24 小时 | 0.13 ZETA | 0.195 ZETA |

---

## 七、验收标准

### 7.1 功能验收

- [ ] Leader 可在前端发起结伴跨链旅行
- [ ] 交易成功后两只青蛙状态同时变为 Traveling
- [ ] 探索过程中两只青蛙共享发现记录
- [ ] 旅行完成后两只青蛙同时返回 Idle
- [ ] 友情值正确增加

### 7.2 异常验收

- [ ] Companion 非 Idle 时无法发起
- [ ] 非好友无法结伴
- [ ] Leader 紧急返回时 Companion 同时解锁
- [ ] 跨链失败时剩余干粮正确退还

---

## 八、假设清单

| 假设 | 待确认 |
|------|--------|
| Companion 所有者无需签名授权 | ⚠️ 需确认：是否需要 off-chain 签名同意 |
| 友情值增加 5 点 | ⚠️ 需确认具体数值 |
| 干粮折扣 1.5 倍 | ⚠️ 需确认折扣比例 |

---

## 九、变更记录

| 日期 | 版本 | 内容 |
|------|------|------|
| 2026-01-15 | 1.0 | 初始需求设计 |
