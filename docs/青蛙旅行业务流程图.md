# ZetaFrog 青蛙旅行业务流程图

## 1. 完整旅行流程（端到端）

```mermaid
flowchart TD
    Start([用户发起旅行]) --> CheckWallet{钱包已连接?}
    CheckWallet -->|否| ConnectWallet[连接钱包]
    ConnectWallet --> CheckWallet
    CheckWallet -->|是| SelectFrog[选择青蛙]
    
    SelectFrog --> CheckStatus{青蛙状态检查}
    CheckStatus -->|旅行中| ShowTraveling[显示旅行中状态]
    CheckStatus -->|冷却中| ShowCooldown[显示冷却倒计时]
    CheckStatus -->|空闲| ChooseDestination{选择目的地}
    
    ChooseDestination -->|随机探索| SetRandomTarget[目标地址=0x0]
    ChooseDestination -->|访问好友| SelectFriend[选择好友地址]
    
    SetRandomTarget --> SetDuration[设置旅行时长]
    SelectFriend --> SetDuration
    
    SetDuration --> SendTransaction[发送链上交易<br/>startTravel]
    
    SendTransaction --> WaitConfirm{交易确认}
    WaitConfirm -->|失败| ShowError[显示错误信息]
    WaitConfirm -->|成功| EmitEvent[触发TravelStarted事件]
    
    EmitEvent --> BackendListen[后端监听事件]
    BackendListen --> CreateTravelRecord[创建旅行记录<br/>status=Traveling]
    
    CreateTravelRecord --> UpdateFrogStatus[更新青蛙状态<br/>isTraveling=true]
    UpdateFrogStatus --> StartTimer[开始计时器]
    
    StartTimer --> WaitTravel{等待旅行结束}
    WaitTravel -->|时间未到| ShowProgress[显示旅行进度]
    ShowProgress --> WaitTravel
    
    WaitTravel -->|时间已到| ProcessCompletion[TravelProcessor<br/>处理完成]
    
    ProcessCompletion --> GenerateDiscoveries[生成探索发现<br/>- 物品/事件/角色]
    GenerateDiscoveries --> MintSouvenir[铸造纪念品NFT<br/>链上操作]
    
    MintSouvenir --> AddXP[增加经验值<br/>更新青蛙等级]
    AddXP --> GenerateJournal[AI生成旅行日记<br/>- 基于发现内容<br/>- 情感分析]
    
    GenerateJournal --> UploadIPFS[上传数据到IPFS<br/>- 日记<br/>- 纪念品图片]
    UploadIPFS --> UpdateRecord[更新旅行记录<br/>status=Completed]
    
    UpdateRecord --> CheckBadges[检查徽章解锁条件]
    CheckBadges --> UnlockBadges[解锁新徽章]
    
    UnlockBadges --> EmitCompleteEvent[触发TravelCompleted事件]
    EmitCompleteEvent --> UpdateFrogStatus2[更新青蛙状态<br/>isTraveling=false<br/>lastTravelTime=now]
    
    UpdateFrogStatus2 --> NotifyFrontend[通知前端更新]
    NotifyFrontend --> ShowResults[显示旅行结果<br/>- 日记<br/>- 纪念品<br/>- 新徽章]
    
    ShowResults --> StartCooldown[开始冷却期<br/>1分钟]
    StartCooldown --> End([流程结束])
    
    ShowError --> End
    ShowTraveling --> End
    ShowCooldown --> End
```

## 2. 前端交互流程

```mermaid
flowchart TD
    A[用户点击"开始旅行"] --> B{检查青蛙状态}
    B -->|空闲| C[显示旅行配置面板]
    B -->|旅行中| D[显示旅行进度界面]
    B -->|冷却中| E[显示冷却倒计时]
    
    C --> F{选择旅行类型}
    F -->|随机探索| G[目标地址=0x0<br/>选择时长: 1/5/10分钟]
    F -->|访问好友| H[从好友列表选择<br/>目标地址=好友地址<br/>选择时长]
    
    G --> I[调用wagmi usePrepareContractWrite]
    H --> I
    
    I --> J[准备交易参数<br/>- tokenId<br/>- targetWallet<br/>- duration<br/>- chainId]
    
    J --> K[调用useContractWrite<br/>执行startTravel]
    
    K --> L{交易状态监听}
    L -->|pending| M[显示交易确认中...]
    L -->|success| N[显示交易成功]
    L -->|error| O[显示错误并回滚UI]
    
    N --> P[useWaitForTransaction<br/>等待区块确认]
    P --> Q[更新本地状态<br/>frog.isTraveling=true]
    
    Q --> R[轮询后端API<br/>/api/travels/:frogId/active]
    R --> S[显示旅行倒计时]
    
    S --> T{定时检查}
    T -->|未结束| S
    T -->|已结束| U[调用/api/travels/:travelId/complete]
    
    U --> V[获取旅行结果]
    V --> W[显示结果页面<br/>- 日记内容<br/>- 纪念品图片<br/>- 经验值增长<br/>- 新解锁徽章]
```

## 3. 后端处理流程

```mermaid
flowchart TD
    A[EventListener监听区块链] --> B{检测到事件?}
    B -->|TravelStarted| C[handleTravelStarted]
    B -->|TravelCompleted| D[handleTravelCompleted]
    B -->|其他事件| E[其他处理器]
    
    C --> F[解析事件参数<br/>- tokenId<br/>- targetWallet<br/>- startTime<br/>- duration]
    
    F --> G[查询青蛙信息<br/>from数据库]
    G --> H[创建Travel记录<br/>status=Traveling<br/>endTime=计算]
    
    H --> I[更新Frog记录<br/>isTraveling=true<br/>lastTravelTime=now]
    
    I --> J[TravelProcessor<br/>添加到处理队列]
    
    J --> K{定时检查: 当前时间>=endTime?}
    K -->|否| K
    K -->|是| L[processTravelCompletion]
    
    L --> M[AI生成探索发现<br/>调用AIService]
    M --> N{有纪念品?}
    N -->|是| O[调用合约mintSouvenir<br/>链上操作]
    N -->|否| P[跳过铸造]
    
    O --> Q[等待区块确认]
    P --> Q
    
    Q --> R[IPFS上传<br/>- 纪念品图片<br/>- 元数据]
    R --> S[AI生成旅行日记<br/>- 基于探索内容<br/>- 情感分析mood]
    
    S --> T[更新Travel记录<br/>- diary<br/>- diaryMood<br/>- discoveries<br/>- souvenir<br/>- status=Completed]
    
    T --> U[增加青蛙经验值<br/>计算等级提升]
    U --> V[检查并解锁徽章<br/>BadgeService]
    
    V --> W[更新Frog记录<br/>- isTraveling=false<br/>- totalTravels++<br/>- currentXP<br/>- level]
    
    W --> X[记录日志]
    X --> Y([处理完成])
    
    D --> Z[handleTravelCompleted<br/>验证状态一致性]
    Z --> Y
```

## 4. AI聊天发起旅行流程

```mermaid
flowchart TD
    A[用户在聊天框输入] --> B[发送到后端<br/>/api/chat/message]
    B --> C[ChatService.handleMessage]
    
    C --> D[调用通义千问API<br/>意图识别]
    D --> E{识别到的意图}
    
    E -->|START_TRAVEL| F[提取参数<br/>- 目的地类型<br/>- 时长]
    E -->|GENERAL_CHAT| G[返回聊天响应]
    E -->|其他意图| H[相应处理]
    
    F --> I[获取当前青蛙信息<br/>- tokenId<br/>- 状态]
    I --> J{青蛙可旅行?}
    
    J -->|否| K[返回错误提示<br/>例如:冷却中/旅行中]
    J -->|是| L[确定目标地址<br/>随机探索=0x0<br/>访问好友=好友地址]
    
    L --> M[返回特殊响应<br/>type=START_TRAVEL<br/>data包含交易参数]
    
    M --> N[前端ChatPanel接收]
    N --> O{消息类型检查}
    
    O -->|START_TRAVEL| P[提取交易参数<br/>- tokenId<br/>- targetWallet<br/>- duration<br/>- chainId]
    
    O -->|普通消息| Q[渲染聊天消息]
    
    P --> R[调用startTravel合约方法<br/>使用wagmi]
    R --> S[显示交易状态提示]
    S --> T{交易结果}
    
    T -->|成功| U[在聊天中显示<br/>"旅行已开始!"]
    T -->|失败| V[在聊天中显示<br/>错误信息]
    
    U --> W([后续流程同普通旅行])
    V --> X([用户可重试])
    K --> X
```

## 5. 数据流转图

```mermaid
flowchart LR
    subgraph "前端 Frontend"
        A1[TravelPage组件]
        A2[ChatPanel组件]
        A3[TravelHistory组件]
        A4[FrogDetail组件]
    end
    
    subgraph "智能合约 Smart Contract"
        B1[ZetaFrogNFT.sol]
        B2[TravelStarted Event]
        B3[TravelCompleted Event]
    end
    
    subgraph "后端 Backend"
        C1[EventListener]
        C2[TravelService]
        C3[TravelProcessor]
        C4[AIService]
        C5[IPFSService]
        C6[BadgeService]
    end
    
    subgraph "数据存储 Storage"
        D1[PostgreSQL]
        D2[IPFS]
        D3[ZetaChain]
    end
    
    A1 -->|startTravel交易| B1
    A2 -->|AI意图→交易| B1
    B1 -->|触发事件| B2
    B2 -->|监听| C1
    
    C1 -->|创建记录| C2
    C2 -->|保存| D1
    C2 -->|加入队列| C3
    
    C3 -->|生成内容| C4
    C4 -->|上传图片/元数据| C5
    C5 -->|返回URL| D2
    
    C3 -->|铸造纪念品| B1
    B1 -->|链上记录| D3
    B1 -->|触发| B3
    
    B3 -->|监听| C1
    C1 -->|更新记录| C2
    C2 -->|检查徽章| C6
    
    C6 -->|更新| D1
    D1 -->|查询| C2
    C2 -->|API响应| A3
    C2 -->|API响应| A4
```

## 6. 关键时序说明

### 6.1 旅行开始阶段
1. **T0**: 用户发起交易
2. **T0+5s**: 交易上链确认
3. **T0+10s**: EventListener捕获事件
4. **T0+15s**: 数据库记录创建完成
5. **T0+20s**: 前端显示旅行中状态

### 6.2 旅行进行阶段
- 前端每30秒轮询一次旅行状态
- TravelProcessor每10秒检查一次待完成的旅行
- 青蛙动画状态更新(桌面宠物显示旅行中)

### 6.3 旅行完成阶段
1. **T_end**: 到达endTime
2. **T_end+10s**: TravelProcessor检测到
3. **T_end+15s**: AI生成探索内容(2-5秒)
4. **T_end+25s**: 铸造纪念品交易(如有,10-15秒)
5. **T_end+40s**: IPFS上传(5-10秒)
6. **T_end+50s**: AI生成日记(5-10秒)
7. **T_end+60s**: 数据库更新完成
8. **T_end+65s**: TravelCompleted事件触发
9. **T_end+70s**: 前端获取结果并展示

## 7. 异常处理流程

```mermaid
flowchart TD
    A[检测到异常] --> B{异常类型}
    
    B -->|交易失败| C[Gas不足/拒绝签名]
    B -->|网络错误| D[RPC连接失败]
    B -->|状态冲突| E[青蛙状态不一致]
    B -->|AI服务异常| F[生成内容失败]
    B -->|IPFS上传失败| G[网络超时]
    
    C --> H[回滚UI状态<br/>显示友好错误]
    D --> I[切换备用RPC<br/>重试3次]
    E --> J[从链上同步状态<br/>修正数据库]
    F --> K[使用默认模板<br/>记录错误日志]
    G --> L[重试上传<br/>或使用本地缓存]
    
    H --> M[通知用户]
    I --> N{重试成功?}
    N -->|是| O[继续流程]
    N -->|否| M
    
    J --> O
    K --> O
    L --> N
    M --> P([结束异常处理])
    O --> P
```

## 8. 状态机图

```mermaid
stateDiagram-v2
    [*] --> Idle: 青蛙创建/旅行完成+冷却结束
    
    Idle --> Preparing: 用户发起旅行
    Preparing --> Idle: 取消/交易失败
    Preparing --> Traveling: 交易确认
    
    Traveling --> Processing: 到达endTime
    Processing --> Completing: 内容生成完成
    Completing --> Completed: 数据保存成功
    
    Completed --> Cooldown: 触发冷却期
    Cooldown --> Idle: 冷却结束(1分钟)
    
    Traveling --> Error: 异常中断
    Processing --> Error: 处理失败
    Error --> Idle: 状态修复
```

---

## 业务规则总结

### 旅行限制
- ✅ 同一青蛙同时只能进行一次旅行
- ✅ 旅行完成后有1分钟冷却期
- ✅ 随机探索(目标地址=0x0)和访问好友均可触发
- ✅ 支持三种时长: 1分钟/5分钟/10分钟(测试环境)

### 奖励机制
- 🎁 每次旅行必得经验值(基础10 XP)
- 🎁 30%概率获得纪念品NFT
- 🎁 探索发现类型: 物品/事件/角色
- 🏆 累计旅行次数解锁徽章

### 数据持久化
- 📝 所有旅行记录永久保存在PostgreSQL
- 🖼️ 纪念品图片和元数据存储在IPFS
- ⛓️ 纪念品NFT和旅行事件记录在ZetaChain
- 💾 日记内容支持情感分析(7种情绪)
