---
status: 待审核
version: 1.0
last_updated: 2026-01-14
reviewer: 用户
---

# 家园系统 V2.0 开发任务

> 基于 V2.0 增强方案拆解的详细开发任务

---

## 开发概览

| 优先级 | 任务数 | 预估工时 |
|--------|--------|----------|
| P0 (必须) | 17 项 | 15h |
| P1 (优先) | 6 项 | 4h |
| P2 (后续) | 10 项 | - |
| **合计** | **33 项** | **19h+** |

---

## P0: 核心体验优化（必须完成）

### 阶段一：数据库模型升级

- [ ] 1.1 修改 `Decoration` 模型，新增字段：
  - `gridWidth: Int @default(1)`
  - `gridHeight: Int @default(1)`
  - `buffType: String?`
  - `buffValue: Float?`
  - `weatherAnim: String?`
  - `rarity: Int @default(1)`

- [ ] 1.2 修改 `PlacedItem` 模型：
  - 将 `x: Float` 改为 `gridX: Int`
  - 将 `y: Float` 改为 `gridY: Int`
  - 新增 `state: String @default("normal")`

- [ ] 1.3 修改 `RoomLayout` 模型，新增字段：
  - `gridCols: Int @default(12)`
  - `gridRows: Int @default(10)`
  - `editLock: String?`
  - `comfortScore: Int @default(0)`

- [ ] 1.4 新增 `DailyTreasure` 模型

- [ ] 1.5 新增 `OfflineBonus` 模型

- [ ] 1.6 编写数据迁移脚本（现有布局坐标转换为网格坐标）

---

### 阶段二：格栅系统后端

- [ ] 2.1 `decoration.service.ts`: 新增 `checkGridCollision()` 方法
  - 输入：占用网格矩阵、待放置物品信息
  - 输出：是否冲突

- [ ] 2.2 `decoration.service.ts`: 修改 `saveLayout()` 方法
  - 支持 gridX/gridY 坐标
  - 调用冲突检测
  - 更新舒适度分数

- [ ] 2.3 `homestead.routes.ts`: 修改布局保存 API
  - 请求体支持 gridX/gridY
  - 返回 comfortScore 和 activeBuffs

- [ ] 2.4 编写单元测试：网格冲突检测边界测试

---

### 阶段三：格栅系统前端

- [ ] 3.1 新增 `GridOverlay.tsx` 组件
  - 渲染 12×10 网格线
  - 高亮当前拖拽物品占用的网格
  - 冲突区域显示红色
  - 可放置区域显示绿色

- [ ] 3.2 新增 `useGridEditor.ts` Hook
  - 管理编辑模式状态 (browse/edit)
  - 处理像素坐标到网格坐标的转换
  - 本地冲突检测逻辑

- [ ] 3.3 修改 `GardenScene.tsx`
  - 装修模式时渲染 GridOverlay
  - 支持模式切换按钮

- [ ] 3.4 修改 `DraggableItem.tsx`
  - 实现网格吸附（Snap-to-grid）
  - 拖拽时调用冲突检测
  - 更新视觉反馈

- [ ] 3.5 实现拖拽预检测颜色反馈
  - 绿色：可放置
  - 红色：冲突

---

### 阶段四：多态编辑模式

- [ ] 4.1 前端状态管理
  - 新增 `editorMode` 状态 (browse/edit)
  - 保存到 localStorage

- [ ] 4.2 装修模式切换按钮 UI
  - 浏览模式：普通视图
  - 装修模式：显示编辑工具栏

- [ ] 4.3 装修模式下非交互物体半透明效果
  - 不可拖拽的物品 opacity: 0.5

- [ ] 4.4 模式切换过渡动画

---

## P1: 安全与收益系统

### 阶段五：资产校验（编辑锁）

- [ ] 5.1 `homestead.routes.ts`: 新增接口
  - `POST /:frogId/layout/:sceneType/lock` 获取编辑锁
  - `DELETE /:frogId/layout/:sceneType/lock` 释放编辑锁

- [ ] 5.2 `decoration.service.ts`: 新增方法
  - `acquireEditLock(layoutId, sessionId)`
  - `releaseEditLock(layoutId, sessionId)`
  - 锁有效期：5 分钟

- [ ] 5.3 前端修改
  - 进入编辑模式时请求锁
  - 退出时释放锁
  - 显示锁定状态提示

- [ ] 5.4 锁过期自动释放逻辑

---

### 阶段六：舒适度计算

- [ ] 6.1 新增 `comfort.service.ts`
  - `calculateComfort(items)`: 计算舒适度分数
  - `getActiveBuffs(items)`: 获取激活的 Buff 列表

- [ ] 6.2 布局保存时更新 `comfortScore`

- [ ] 6.3 前端家园信息面板显示舒适度

---

## P2: 增量功能（后续迭代）

### Buff 机制

- [ ] 7.1 新增 `buff.service.ts`
- [ ] 7.2 `getActiveBuffs()` 获取激活的 Buff 列表
- [ ] 7.3 青蛙旅行休息时间应用 `rest_reduce` Buff
- [ ] 7.4 前端显示当前激活的 Buff 列表

### 天气联动

- [ ] 8.1 装饰品天气动画配置
- [ ] 8.2 前端检测天气状态并更新装饰品 state
- [ ] 8.3 天气动画素材和渲染

### 每日寻宝

- [ ] 9.1 新增 `treasure.service.ts`
- [ ] 9.2 `generateTreasure()` 每日宝藏生成
- [ ] 9.3 `claimTreasure()` 领取逻辑
- [ ] 9.4 `garden.routes.ts`: 新增寻宝 API
- [ ] 9.5 前端寻宝入口和领取动画

### 离线收益

- [ ] 10.1 新增 `offline.service.ts`
- [ ] 10.2 登录时计算离线收益
- [ ] 10.3 前端离线收益领取弹窗

---

## 依赖关系

```
阶段一 (数据库升级)
    ↓
阶段二 (后端格栅) ← 依赖阶段一
    ↓
阶段三 (前端格栅) ← 依赖阶段二
    ↓
阶段四 (多态模式) ← 依赖阶段三
    ↓
阶段五 (编辑锁)   ← 依赖阶段四
阶段六 (舒适度)   ← 依赖阶段一（可并行）
```

---

## 变更记录

| 日期 | 版本 | 内容 |
|------|------|------|
| 2026-01-14 | 1.0 | 初始开发任务 |

---
