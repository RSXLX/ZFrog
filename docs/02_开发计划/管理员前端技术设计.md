---
status: 已审核
version: 1.0
last_updated: 2026-01-15
reviewer: 用户
---

# 管理员前端技术设计

> 基于需求设计文档，详细说明管理员前端的技术实现方案。

## 一、系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Admin Frontend (3002)                     │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────┐ │
│  │Dashboard│  │Contract │  │  Frog   │  │     Badge       │ │
│  │  Page   │  │ Manager │  │ Manager │  │    Manager      │ │
│  └────┬────┘  └────┬────┘  └────┬────┘  └───────┬─────────┘ │
│       │            │            │               │           │
│       └────────────┴────────────┴───────────────┘           │
│                          │                                   │
│                    ┌─────▼─────┐                            │
│                    │  API Layer │                            │
│                    └─────┬─────┘                            │
└──────────────────────────┼──────────────────────────────────┘
                           │ HTTP
┌──────────────────────────▼──────────────────────────────────┐
│                   Backend (3001)                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              /api/admin/*  路由                       │   │
│  └─────────────────────────┬────────────────────────────┘   │
│                            │                                 │
│  ┌─────────┐  ┌────────────▼───┐  ┌──────────────────────┐  │
│  │ Prisma  │◄─┤ Admin Services │─►│ Contract Interaction │  │
│  │   DB    │  └────────────────┘  │    (ethers.js)       │  │
│  └─────────┘                      └──────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、前端设计

### 2.1 项目结构

```
admin/
├── public/
│   └── favicon.ico
├── src/
│   ├── components/                 # 通用组件
│   │   ├── Layout/
│   │   │   ├── Sidebar.tsx        # 侧边栏导航
│   │   │   ├── Header.tsx         # 顶部栏
│   │   │   └── MainLayout.tsx     # 主布局
│   │   ├── ContractStatus/
│   │   │   ├── ContractCard.tsx   # 合约状态卡片
│   │   │   └── ChainStatus.tsx    # 链状态组件
│   │   └── DataTable/
│   │       └── DataTable.tsx      # 通用数据表格
│   │
│   ├── pages/                      # 页面组件
│   │   ├── Dashboard/
│   │   │   └── index.tsx          # 仪表盘
│   │   ├── Contracts/
│   │   │   ├── index.tsx          # 合约管理主页
│   │   │   └── ContractDetail.tsx # 合约详情
│   │   ├── Frogs/
│   │   │   ├── index.tsx          # 青蛙列表
│   │   │   └── FrogDetail.tsx     # 青蛙详情
│   │   ├── Badges/
│   │   │   ├── index.tsx          # 徽章列表
│   │   │   └── BadgeForm.tsx      # 徽章编辑表单
│   │   ├── Friends/
│   │   │   └── index.tsx          # 好友关系列表
│   │   ├── Travels/
│   │   │   └── index.tsx          # 旅行记录列表
│   │   └── Config/
│   │       └── index.tsx          # 系统配置
│   │
│   ├── services/                   # API 服务
│   │   ├── api.ts                 # axios 实例
│   │   ├── dashboard.ts           # 仪表盘 API
│   │   ├── contracts.ts           # 合约管理 API
│   │   ├── frogs.ts               # 青蛙管理 API
│   │   ├── badges.ts              # 徽章管理 API
│   │   └── config.ts              # 配置管理 API
│   │
│   ├── stores/                     # Zustand 状态
│   │   └── appStore.ts            # 全局状态
│   │
│   ├── types/                      # TypeScript 类型
│   │   ├── contract.ts
│   │   ├── frog.ts
│   │   └── badge.ts
│   │
│   ├── utils/                      # 工具函数
│   │   ├── format.ts              # 格式化工具
│   │   └── constants.ts           # 常量定义
│   │
│   ├── App.tsx                     # 根组件
│   ├── main.tsx                    # 入口
│   └── index.css                   # 全局样式
│
├── .env                            # 环境变量
├── package.json
├── tsconfig.json
└── vite.config.ts
```

### 2.2 路由设计

| 路径 | 组件 | 描述 |
|------|------|------|
| `/` | Dashboard | 仪表盘首页 |
| `/contracts` | Contracts | 合约管理 |
| `/contracts/:address` | ContractDetail | 合约详情 |
| `/frogs` | Frogs | 青蛙列表 |
| `/frogs/:tokenId` | FrogDetail | 青蛙详情 |
| `/badges` | Badges | 徽章管理 |
| `/friends` | Friends | 好友管理 |
| `/travels` | Travels | 旅行管理 |
| `/config` | Config | 系统配置 |

### 2.3 核心组件设计

#### MainLayout.tsx
```tsx
// 主布局：侧边栏 + 内容区
interface MainLayoutProps {
  children: React.ReactNode;
}
// 使用 Ant Design Layout 组件
// 侧边栏固定宽度 200px，可折叠
// 顶部栏显示当前页面标题
```

#### ContractCard.tsx
```tsx
// 合约状态卡片
interface ContractCardProps {
  name: string;           // 合约名称
  address: string;        // 合约地址
  status: 'active' | 'inactive' | 'unknown';
  version?: string;       // 合约版本
  onVerify: () => void;   // 验证按钮回调
}
// 显示合约地址（可复制）、状态标签、验证按钮
```

#### DataTable.tsx
```tsx
// 通用数据表格（基于 Ant Design Table）
interface DataTableProps<T> {
  columns: ColumnType<T>[];
  dataSource: T[];
  loading?: boolean;
  pagination?: TablePaginationConfig;
  onSearch?: (query: string) => void;
  actions?: ActionConfig[];
}
```

---

## 三、后端 API 设计

### 3.1 新增路由文件

#### [NEW] backend/src/api/routes/admin.routes.ts

```typescript
// 管理员 API 路由
import { Router } from 'express';

const router = Router();

// ========== 仪表盘 ==========
router.get('/dashboard', getDashboard);

// ========== 合约管理 ==========
router.get('/contracts', getContracts);
router.get('/contracts/verify', verifyContracts);
router.post('/contracts/sync-config', syncContractsConfig);

// ========== 青蛙管理 ==========
router.get('/frogs', getFrogs);
router.get('/frogs/:tokenId', getFrogDetail);
router.put('/frogs/:tokenId/status', updateFrogStatus);

// ========== 徽章管理 ==========
router.get('/badges', getBadges);
router.post('/badges', createBadge);
router.put('/badges/:id', updateBadge);
router.delete('/badges/:id', deleteBadge);

// ========== 好友管理 ==========
router.get('/friends', getFriendships);
router.delete('/friends/:id', deleteFriendship);

// ========== 旅行管理 ==========
router.get('/travels', getTravels);
router.get('/travels/:id', getTravelDetail);  // 新增：获取旅行详情
router.put('/travels/:id/force-complete', forceCompleteTravel);

// ========== 配置管理 ==========
router.get('/config', getConfig);
router.put('/config', updateConfig);

// ========== 空投管理 ==========
router.get('/airdrop/stats', getAirdropStats);     // 获取空投统计
router.get('/airdrop/failed', getFailedRewards);   // 获取失败记录
router.post('/airdrop/retry/:id', retryFailedReward); // 重试发放

export default router;
```

### 3.2 API 详细定义

#### GET /api/admin/dashboard
```typescript
// 响应
interface DashboardResponse {
  stats: {
    totalFrogs: number;
    totalTravels: number;
    activeTravels: number;
    totalBadgesUnlocked: number;
    totalFriendships: number;
  };
  services: {
    backend: 'healthy' | 'unhealthy';
    database: 'connected' | 'disconnected';
  };
  chains: {
    chainId: number;
    name: string;
    rpcStatus: 'connected' | 'timeout' | 'error';
    blockNumber?: number;
  }[];
  contracts: {
    name: string;
    address: string;
    isDeployed: boolean;
    version?: string;
  }[];
}
```

#### GET /api/admin/contracts
```typescript
// 响应
interface ContractsResponse {
  zetachain: {
    zetaFrogNFT: ContractInfo;
    omniTravel: ContractInfo;
    travel: ContractInfo;
    souvenir: ContractInfo;
  };
  bscTestnet: {
    connector: ContractInfo;
    footprint: ContractInfo;
  };
  sepolia: {
    connector: ContractInfo;
    footprint: ContractInfo;
  };
}

interface ContractInfo {
  address: string;
  isDeployed: boolean;
  version?: string;
  config?: Record<string, unknown>;  // 链上配置
}
```

#### GET /api/admin/contracts/verify
```typescript
// 响应
interface VerifyResponse {
  checks: {
    name: string;
    passed: boolean;
    message: string;
    expected?: string;
    actual?: string;
  }[];
  allPassed: boolean;
}
```

#### POST /api/admin/contracts/sync-config
```typescript
// 请求
interface SyncConfigRequest {
  contracts: {
    zetaFrogNFT?: string;
    omniTravel?: string;
    travel?: string;
    souvenir?: string;
    bscConnector?: string;
    sepoliaConnector?: string;
  };
}
// 更新 backend/.env 和 frontend/.env
```

#### GET /api/admin/frogs
```typescript
// 请求参数
interface GetFrogsQuery {
  page?: number;
  pageSize?: number;
  search?: string;        // tokenId 或 ownerAddress
  status?: FrogStatus;
}
// 响应
interface FrogsResponse {
  data: FrogRecord[];
  total: number;
  page: number;
  pageSize: number;
}
```

#### PUT /api/admin/frogs/:tokenId/status
```typescript
// 请求
interface UpdateFrogStatusRequest {
  status: 'Idle' | 'Traveling' | 'Returning';
}
// 响应
interface UpdateFrogStatusResponse {
  success: boolean;
  frog: FrogRecord;
}
```

#### POST /api/admin/badges
```typescript
// 请求
interface CreateBadgeRequest {
  code: string;
  name: string;
  description: string;
  icon: string;
  unlockType: BadgeUnlockType;
  unlockCondition: Record<string, unknown>;
  rarity?: number;
  isHidden?: boolean;
  airdropAmount?: string;  // 空投金额 (wei)
}
```

---

## 四、代码变更清单

### 4.1 新增文件

| 位置 | 文件 | 说明 |
|------|------|------|
| `admin/` | 整个目录 | 新建管理员前端项目 |
| `backend/src/api/routes/` | `admin.routes.ts` | 管理员 API 路由 |
| `backend/src/services/` | `admin.service.ts` | 管理员业务逻辑 |

### 4.2 修改文件

| 文件 | 修改内容 |
|------|----------|
| `backend/src/index.ts` | 注册 `/api/admin` 路由 |
| `backend/prisma/schema.prisma` | TravelBadge 新增 `airdropAmount` 字段（可选） |

---

## 五、业务流程图

### 5.1 合约配置同步流程

```
┌─────────┐      ┌──────────────┐      ┌─────────────┐
│ 管理员  │      │  Admin API   │      │  文件系统   │
└────┬────┘      └──────┬───────┘      └──────┬──────┘
     │                  │                     │
     │  1. 输入新地址   │                     │
     │─────────────────►│                     │
     │                  │                     │
     │  2. 验证链上状态 │                     │
     │◄─────────────────│                     │
     │                  │                     │
     │  3. 确认同步     │                     │
     │─────────────────►│                     │
     │                  │  4. 更新 .env 文件  │
     │                  │────────────────────►│
     │                  │                     │
     │  5. 返回成功     │                     │
     │◄─────────────────│                     │
     │                  │                     │
```

### 5.2 青蛙状态重置流程

```
┌─────────┐      ┌──────────────┐      ┌──────────┐
│ 管理员  │      │  Admin API   │      │ Database │
└────┬────┘      └──────┬───────┘      └────┬─────┘
     │                  │                   │
     │  1. 搜索青蛙     │                   │
     │─────────────────►│                   │
     │                  │  2. 查询青蛙      │
     │                  │──────────────────►│
     │                  │                   │
     │  3. 返回青蛙信息 │                   │
     │◄─────────────────│◄──────────────────│
     │                  │                   │
     │  4. 请求重置状态 │                   │
     │─────────────────►│                   │
     │                  │  5. 更新 status   │
     │                  │──────────────────►│
     │                  │                   │
     │  6. 返回成功     │                   │
     │◄─────────────────│                   │
```

---

## 六、验证计划

### 6.1 自动化测试

暂无现有测试可复用，本次不新增自动化测试。

### 6.2 手动验证

#### 测试 1：仪表盘加载
1. 启动后端服务：`cd backend && npm run dev`
2. 启动管理员前端：`cd admin && npm run dev`
3. 浏览器访问 `http://localhost:3002`
4. **预期**：仪表盘正常显示，包含青蛙总数、旅行次数等统计数据

#### 测试 2：合约状态验证
1. 进入合约管理页面 `/contracts`
2. 点击"验证所有合约"按钮
3. **预期**：显示各合约的验证结果（通过/失败）

#### 测试 3：青蛙状态修改
1. 进入青蛙管理页面 `/frogs`
2. 搜索一个状态为 `Traveling` 的青蛙
3. 点击"重置状态"按钮，选择 `Idle`
4. **预期**：弹出确认对话框，确认后状态更新成功

#### 测试 4：徽章 CRUD
1. 进入徽章管理页面 `/badges`
2. 点击"添加徽章"，填写表单并保存
3. **预期**：新徽章出现在列表中
4. 编辑该徽章，修改描述
5. **预期**：修改成功
6. 删除该徽章
7. **预期**：徽章从列表中移除

---

## 七、依赖说明

### 7.1 前端依赖

```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.20.0",
    "antd": "^5.12.0",
    "@ant-design/icons": "^5.2.0",
    "axios": "^1.6.0",
    "zustand": "^4.4.0",
    "dayjs": "^1.11.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "@vitejs/plugin-react": "^4.2.0",
    "typescript": "^5.3.0",
    "vite": "^5.0.0"
  }
}
```

### 7.2 后端依赖

无需新增依赖，复用现有 express、prisma、ethers。

---

## 变更记录

| 日期 | 变更内容 |
|------|----------|
| 2026-01-15 | 初始化技术设计文档 |
| 2026-01-15 | 新增空投管理 API、旅行详情 API、徽章空投奖励展示 |
