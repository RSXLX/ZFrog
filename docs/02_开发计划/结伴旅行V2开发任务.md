# 结伴旅行 V2.0 开发任务

> 状态：已完成 | 最后更新：2026-01-16

## 一、合约层 ✅

### C1. 新增结伴旅行函数 [P0]
- [x] 实现 `startGroupCrossChainTravel()`
- [x] 实现 `calculateGroupProvisions()`
- [x] 实现 `completeGroupTravel()`
- [x] 实现 `emergencyGroupReturn()`

### C2. 新增事件 [P0]
- [x] `GroupCrossChainTravelStarted` 事件
- [x] `GroupCrossChainTravelCompleted` 事件

### C3. 合约升级 [P0]
- [x] 添加函数到 `OmniTravelUpgradeable.sol`
- [x] UUPS 升级代理合约
- [x] 配置支持链（BSC Testnet, Sepolia）

---

## 二、后端层 ✅

### B1. 数据库迁移 [P0]
- [x] 修改 `GroupTravel` 模型添加跨链字段
- [x] 执行 `prisma db push`

### B2. 核心服务 [P0]
- [x] 创建 `group-travel.service.ts`
- [x] 创建 `group-travel.routes.ts`
- [x] 注册到 `index.ts`

### B3. 探索循环 [P1]
- [x] 修改 `exploration-scheduler.service.ts` 支持双人探索
- [x] 完成后增加友情值

---

## 三、前端层 ✅

### F1. 合约交互 [P0]
- [x] 创建 `useGroupCrossChainTravel.ts` Hook

### F2. API 调用 [P0]
- [x] `travel.api.ts` 新增 `prepareGroupCrossChainTravel()` 
- [x] `travel.api.ts` 新增 `confirmGroupCrossChainTravel()`

### F3. 模态框升级 [P1]
- [x] `GroupTravelModal.tsx` 添加随机链选择器
- [x] 添加时长选择器（1分钟/10分钟/1小时/24小时）
- [x] 添加干粮费用显示

---

## 四、验证 ✅

### V1. 编译验证
- [x] 合约编译通过
- [x] 后端编译通过
- [x] 前端编译通过

### V2. 集成测试
- [x] 发起结伴跨链旅行（交易已上链）
- [x] 两只青蛙状态同步
- [x] 后端记录成功

---

## 测试脚本

| 脚本 | 说明 |
|------|------|
| `backend/scripts/test-group-travel.ts` | 完整测试脚本 |
| `contracts/scripts/upgrade-omnitravel.js` | UUPS 升级脚本 |
| `contracts/scripts/configure-group-travel.js` | 链配置脚本 |
| `contracts/scripts/check-frog-status.js` | 青蛙状态检查 |
| `contracts/scripts/diagnose-omnitravel.js` | 合约诊断 |
