---
status: 已审核
version: 2.0
last_updated: 2026-01-13
reviewer: AI (根据实际代码检查)
---

# 旅行系统模块规格

> 本文档定义旅行系统模块的技术规格和实现约定。

---

## 一、模块概述

旅行系统是 ZetaFrog 核心玩法模块，负责管理青蛙的本地旅行和跨链旅行功能。

| 属性 | 值 |
|------|------|
| 模块名称 | 旅行系统 (Travel System) |
| 依赖模块 | 用户系统、青蛙NFT系统、徽章系统、好友系统 |
| 技术栈 | Node.js + TypeScript + Prisma + Solidity |

---

## 二、核心功能

### 2.1 本地旅行

| 功能点 | 说明 | 优先级 | 状态 |
|--------|------|--------|------|
| 随机旅行 | 系统随机选择目的地和探索对象 | P0 | ✅ 已实现 |
| 定点旅行 | 用户指定链和/或钱包地址 | P0 | ✅ 已实现 |
| 旅行进度 | 实时显示旅行状态和进度 | P0 | ✅ 已实现 |
| 旅行日记 | AI 生成可爱风格的旅行见闻 | P0 | ✅ 已实现 |
| 纪念品 | 根据探索发现生成纪念品 | P0 | ✅ 已实现 |
| 徽章解锁 | 满足条件自动解锁旅行徽章 | P0 | ✅ 已实现 |

### 2.2 跨链旅行

| 功能点 | 说明 | 优先级 | 状态 |
|--------|------|--------|------|
| 链选择 | 选择目标区块链 | P1 | ✅ 已实现 |
| Gas 估算 | 显示跨链 Gas 费用 | P1 | ✅ 已实现 |
| 跨链消息 | 通过 ZetaChain 发送跨链消息 | P1 | ✅ 已实现 |
| 实时探索 | 旅行进行中每 30s 生成探索记录 | P1 | ✅ 已实现 |
| 状态追踪 | 追踪跨链旅行状态 | P1 | ✅ 已实现 |

### 2.3 结伴旅行

| 功能点 | 说明 | 优先级 | 状态 |
|--------|------|--------|------|
| 好友验证 | 结伴旅行必须是好友 | P1 | ✅ 已实现 |
| 开始互动 | 创建 FriendInteraction 记录 | P1 | ✅ 已实现 |
| 完成通知 | WebSocket 通知好友 | P1 | ✅ 已实现 |
| 完成互动 | 创建 FriendInteraction 记录 | P1 | ✅ 已实现 |

> **好友系统集成**：结伴旅行依赖好友系统的 `Friendship` 和 `FriendInteraction` 表，通过 `notifyFriendInteraction` 推送 WebSocket 事件。

---

## 三、链支持配置

| 链名称 | Chain ID | 环境 | 状态 |
|--------|----------|------|------|
| BSC Testnet | 97 | 测试网 | ✅ 支持 |
| Sepolia | 11155111 | 测试网 | ✅ 支持 |
| ZetaChain Athens | 7001 | 测试网 | ✅ 支持 |
| Ethereum | 1 | 主网 | 🔜 计划 |
| Arbitrum | 42161 | 主网 | 🔜 计划 |
| Base | 8453 | 主网 | 🔜 计划 |

---

## 四、数据规格

### 4.1 旅行状态机

```
PENDING → DEPARTING → TRAVELING → EXPLORING → RETURNING → COMPLETED
                ↓          ↓           ↓           ↓
              FAILED     FAILED     FAILED      FAILED
```

### 4.2 旅行时长配置

| 旅行类型 | 最短时长 | 标准时长 | 最长时长 |
|----------|----------|----------|----------|
| 本地随机 | 60s | 120s | 180s |
| 本地定点 | 90s | 150s | 210s |
| 跨链旅行 | 180s | 300s | 600s |

### 4.3 发现稀有度

| 稀有度 | 名称 | 概率 | 示例 |
|--------|------|------|------|
| 1 | 普通 | 40% | 空钱包、新手钱包 |
| 2 | 少见 | 30% | 小额余额、少量交易 |
| 3 | 稀有 | 20% | 活跃钱包、特殊时期 |
| 4 | 罕见 | 8% | 大户钱包 |
| 5 | 传说 | 2% | 巨鲸钱包 |

### 4.4 纪念品类型

| 类型 | 名称 | 图标 | 出现概率 |
|------|------|------|----------|
| postcard | 明信片 | 📮 | 20% |
| leaf | 树叶 | 🍂 | 20% |
| stone | 石头 | 🪨 | 15% |
| photo | 照片 | 📷 | 15% |
| story | 故事 | 📖 | 10% |
| feather | 羽毛 | 🪶 | 10% |
| shell | 贝壳 | 🐚 | 10% |

---

## 五、徽章规格

### 5.1 旅行次数徽章

| 代码 | 名称 | 条件 | 图标 | 稀有度 |
|------|------|------|------|--------|
| FIRST_TRIP | 第一次出门 | 1 次旅行 | 🎒 | 1 |
| FREQUENT_TRAVELER | 常旅客 | 5 次旅行 | ✈️ | 2 |
| TRAVEL_ADDICT | 旅行上瘾 | 20 次旅行 | 🌍 | 3 |
| TRAVEL_MASTER | 旅行大师 | 50 次旅行 | 🏆 | 4 |

### 5.2 链访问徽章

| 代码 | 名称 | 条件 | 图标 | 稀有度 |
|------|------|------|------|--------|
| BSC_VISITOR | BSC 游客 | 访问 BSC 3 次 | 🟡 | 2 |
| ETH_VISITOR | 以太坊游客 | 访问 ETH 3 次 | 💎 | 2 |
| ZETA_VISITOR | ZetaChain 游客 | 访问 ZetaChain 3 次 | ⚡ | 2 |

### 5.3 多链徽章

| 代码 | 名称 | 条件 | 图标 | 稀有度 |
|------|------|------|------|--------|
| CHAIN_HOPPER | 链间旅行者 | 访问 2 条链 | 🌉 | 2 |
| OMNI_TRAVELER | 全链旅行家 | 访问所有 3 条链 | 🌈 | 3 |

### 5.4 发现徽章

| 代码 | 名称 | 条件 | 图标 | 稀有度 |
|------|------|------|------|--------|
| LUCKY_FINDER | 幸运儿 | 发现 4 星以上 | 🍀 | 3 |
| WHALE_WATCHER | 观鲸者 | 发现巨鲸钱包 | 🐋 | 4 |

---

## 六、接口约定

### 6.1 路由前缀

| 模块 | 前缀 |
|------|------|
| 旅行 | `/api/travel` |
| 跨链旅行 | `/api/cross-chain/travel` |
| 徽章 | `/api/badges` |

### 6.2 响应格式

```typescript
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
  };
}
```

---

## 七、服务依赖

| 服务 | 用途 | 必需 |
|------|------|------|
| PostgreSQL | 数据存储 | ✅ |
| Redis | 任务队列、缓存 | ✅ |
| OpenAI API | AI 日记生成 | ✅ |
| RPC 节点 | 链上数据获取 | ✅ |

### 7.1 RPC 配置

| 链 | 环境变量 | 默认值 |
|------|----------|--------|
| BSC Testnet | `BSC_TESTNET_RPC` | https://data-seed-prebsc-1-s1.binance.org:8545 |
| Sepolia | `ETH_SEPOLIA_RPC` | https://rpc.sepolia.org |
| ZetaChain Athens | `ZETA_ATHENS_RPC` | https://zetachain-athens-evm.blockpi.network/v1/rpc/public |

---

## 八、性能要求

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 旅行启动响应 | < 500ms | 不含链上确认 |
| 进度查询响应 | < 100ms | 缓存命中 |
| 日记生成时间 | < 10s | AI 生成 |
| 单用户并发旅行 | 1 | 同时只能一只青蛙旅行 |

---

## 九、安全要求

| 要求 | 说明 |
|------|------|
| 认证 | 所有接口需要 JWT Token |
| 所有权验证 | 操作青蛙前验证 NFT 所有权 |
| Rate Limiting | 发起旅行 10 次/分钟 |
| 输入验证 | 地址格式、链类型验证 |

---

## 十、变更记录

| 日期 | 版本 | 内容 |
|------|------|------|
| 2026-01-13 | 1.0 | 初始模块规格 |
| 2026-01-14 | 1.1 | 新增结伴旅行功能说明，添加好友系统依赖 |
| 2026-01-15 | 1.2 | 新增跨链旅行实时探索功能（ON_TARGET_CHAIN 阶段每 30s 生成探索记录） |

---
