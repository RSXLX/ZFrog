---
status: 已审核
version: 1.0
last_updated: 2026-01-14
reviewer: AI (根据实际代码检查)
---

# 跨链交互模块规格

> 本文档定义跨链交互模块的技术规格和实现约定。

---

## 一、模块概述

跨链交互模块基于 ZetaChain 全链互操作性，实现青蛙跨链旅行功能。

| 属性 | 值 |
|------|------|
| 模块名称 | 跨链交互系统 (Cross-Chain System) |
| 依赖模块 | 青蛙NFT系统、旅行系统 |
| 技术栈 | Solidity + ZetaChain + Node.js |
| 部署链 | ZetaChain Athens (测试网) |

---

## 二、支持的链

| 链名 | ChainId | 代码 | 角色 |
|------|---------|------|------|
| ZetaChain Athens | 7001 | ZETACHAIN_ATHENS | 主链 (Hub) |
| BSC Testnet | 97 | BSC_TESTNET | 目标链 |
| Ethereum Sepolia | 11155111 | ETH_SEPOLIA | 目标链 |

---

## 三、核心功能

### 3.1 跨链旅行

| 功能点 | 说明 | 优先级 | 状态 |
|--------|------|--------|------|
| 资格检查 | 检查青蛙状态和余额 | P0 | ✅ 已实现 |
| 发起旅行 | 锁定青蛙并发送跨链消息 | P0 | ✅ 已实现 |
| 到达确认 | 目标链接收青蛙 | P0 | ✅ 已实现 |
| 实时探索 | 旅行进行中生成探索记录 | P0 | ✅ 已实现 |
| 返回处理 | 完成探索并返回主链 | P0 | ✅ 已实现 |
| 状态追踪 | 实时跟踪跨链状态 | P0 | ✅ 已实现 |

### 3.2 状态管理

| 功能点 | 说明 | 优先级 | 状态 |
|--------|------|--------|------|
| 链上同步 | 同步链上状态到数据库 | P1 | ✅ 已实现 |
| 状态协调 | 检测并修复状态不一致 | P1 | ✅ 已实现 |
| 超时处理 | 处理跨链超时情况 | P1 | ✅ 已实现 |

---

## 四、跨链状态

### 4.1 状态流转

```
LOCKING → LOCKED → CROSSING_OUT → ON_TARGET_CHAIN → CROSSING_BACK → UNLOCKING → COMPLETED
                                        ↓
                                    [探索阶段]
```

### 4.2 状态说明

| 状态 | 说明 | 持续时间 |
|------|------|----------|
| LOCKING | 青蛙正在被锁定 | < 1分钟 |
| LOCKED | 青蛙已锁定，等待跨链 | < 1分钟 |
| CROSSING_OUT | 跨链消息发送中 | 1-5分钟 |
| ON_TARGET_CHAIN | 在目标链探索中 | 用户设定 |
| CROSSING_BACK | 返回消息发送中 | 1-5分钟 |
| UNLOCKING | 青蛙正在解锁 | < 1分钟 |
| COMPLETED | 旅行完成 | 终态 |
| TIMEOUT | 超时 | 需干预 |
| FAILED | 失败 | 需干预 |

---

## 五、智能合约

### 5.1 合约清单

| 合约 | 文件 | 部署链 | 说明 |
|------|------|--------|------|
| OmniTravel | OmniTravel.sol | ZetaChain | 跨链旅行主合约 |
| OmniTravelUpgradeable | upgradeable/ | ZetaChain | 可升级版本 |
| FrogConnector | FrogConnector.sol | BSC/ETH | 目标链接收器 |

### 5.2 主要事件

| 事件 | 参数 | 说明 |
|------|------|------|
| CrossChainTravelStarted | (tokenId, targetChain, messageId) | 旅行开始 |
| CrossChainTravelCompleted | (tokenId, xpEarned) | 旅行完成 |
| FrogArrived | (tokenId, fromChain) | 青蛙到达 |
| FrogDeparted | (tokenId, toChain) | 青蛙离开 |

---

## 六、数据规格

### 6.1 Travel 扩展字段

| 字段 | 类型 | 说明 |
|------|------|------|
| isCrossChain | Boolean | 是否跨链旅行 |
| crossChainStatus | CrossChainStatus | 跨链状态 |
| crossChainMessageId | String | 跨链消息 ID |
| lockTxHash | String | 锁定交易哈希 |
| unlockTxHash | String | 解锁交易哈希 |
| targetChainArrivalTime | DateTime | 到达时间 |
| returnMessageId | String | 返回消息 ID |
| crossChainXpEarned | Int | 跨链奖励 XP |

### 6.2 CrossChainMessage 表

| 字段 | 类型 | 说明 |
|------|------|------|
| messageId | String | 唯一消息 ID |
| tokenId | Int | 青蛙 TokenId |
| sourceChain | ChainType | 源链 |
| targetChain | ChainType | 目标链 |
| direction | MessageDirection | OUT/BACK |
| status | CrossChainMessageStatus | 消息状态 |
| gasUsed | String | 消耗 Gas |

---

## 七、接口约定

### 7.1 路由前缀

| 模块 | 前缀 |
|------|------|
| 跨链 | `/api/v1/cross-chain` |

### 7.2 响应格式

```typescript
interface CrossChainResponse<T> {
  success: boolean;
  data?: T;
  message?: string;
  error?: string;
}
```

---

## 八、性能要求

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 资格检查响应 | < 500ms | 含链上查询 |
| 跨链消息确认 | < 5分钟 | ZetaChain 标准 |
| 状态同步延迟 | < 1分钟 | 事件监听 |

---

## 九、安全要求

| 要求 | 说明 |
|------|------|
| 所有权验证 | 发起旅行前验证 NFT 所有权 |
| 状态保护 | 只有授权合约可修改青蛙状态 |
| 超时保护 | 超时后可紧急重置 |
| 重入保护 | ReentrancyGuard |

---

## 十、代码实现

### 10.1 后端文件

| 文件 | 大小 | 说明 |
|------|------|------|
| `cross-chain.routes.ts` | 407行 | API 路由 |
| `omni-travel.service.ts` | 40KB | 核心服务 |
| `cross-chain-listener.service.ts` | 22KB | 事件监听 |

### 10.2 合约文件

| 文件 | 说明 |
|------|------|
| `OmniTravel.sol` | 跨链旅行主合约 |
| `FrogConnector.sol` | 目标链连接器 |
| `OmniTravelUpgradeable.sol` | 可升级版本 |

---

## 十一、变更记录

| 日期 | 版本 | 内容 |
|------|------|------|
| 2026-01-14 | 1.0 | 初始模块规格 |
| 2026-01-15 | 1.1 | 新增实时探索功能（ON_TARGET_CHAIN 阶段每 30s 生成探索记录） |

---
