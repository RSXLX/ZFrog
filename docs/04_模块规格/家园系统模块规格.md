---
status: 待审核
version: 2.0
last_updated: 2026-01-14
reviewer: 用户
---

# 家园系统模块规格

> 本文档定义家园系统模块的技术规格和实现约定。

---

## 一、模块概述

家园系统是青蛙的专属空间，包含装饰编辑、礼物收发、相册管理和好友访问功能。V2.0 版本引入格栅系统、环境影响因子、资产校验和社交深度化功能。

| 属性 | 值 |
|------|------|
| 模块名称 | 家园系统 (Homestead System) |
| 版本 | V2.0 |
| 依赖模块 | 青蛙NFT系统、好友系统 |
| 技术栈 | Node.js + TypeScript + Prisma |

---

## 二、核心功能

### 2.1 装饰系统

| 功能点 | 说明 | 版本 | 状态 |
|--------|------|------|------|
| 装饰品库存 | 管理拥有的装饰品 | V1.0 | ✅ |
| 布局编辑 | 拖拽放置装饰品 | V1.0 | ✅ |
| 布局历史 | 历史版本恢复 | V1.0 | ✅ |
| 版本控制 | 乐观锁防冲突 | V1.0 | ✅ |
| **格栅系统** | 网格对齐放置 | **V2.0** | 📝 待开发 |
| **多态编辑模式** | 浏览/装修模式切换 | **V2.0** | 📝 待开发 |
| **预检测反馈** | 拖拽时颜色提示 | **V2.0** | 📝 待开发 |

### 2.2 礼物系统

| 功能点 | 说明 | 版本 | 状态 |
|--------|------|------|------|
| 发送礼物 | 给好友送礼 | V1.0 | ✅ |
| 接收礼物 | 领取收到的礼物 | V1.0 | ✅ |
| NFT礼物 | 支持NFT转赠 | V1.0 | ✅ |

### 2.3 相册系统

| 功能点 | 说明 | 版本 | 状态 |
|--------|------|------|------|
| 照片上传 | 保存旅行照片 | V1.0 | ✅ |
| 相册浏览 | 分页查看照片 | V1.0 | ✅ |
| NFT铸造 | 将照片铸造为NFT | V1.0 | ✅ |

### 2.4 访问系统

| 功能点 | 说明 | 版本 | 状态 |
|--------|------|------|------|
| 好友访问 | 访问好友家园 | V1.0 | ✅ |
| 实时互动 | 点赞/喂食/合影 | V1.0 | ✅ |
| 留言板 | 签名留言 | V1.0 | ✅ |
| **每日寻宝** | 访问时随机奖励 | **V2.0** | 📝 待开发 |

### 2.5 【V2.0】环境系统

| 功能点 | 说明 | 版本 | 状态 |
|--------|------|------|------|
| 舒适度计算 | 根据装饰品计算分数 | V2.0 | 📝 待开发 |
| Buff 机制 | 装饰品提供增益效果 | V2.0 | 📝 待开发 |
| 天气联动 | 天气影响装饰品动画 | V2.0 | 📝 待开发 |
| 离线收益 | 根据舒适度产出 | V2.0 | 📝 待开发 |

### 2.6 【V2.0】安全系统

| 功能点 | 说明 | 版本 | 状态 |
|--------|------|------|------|
| 编辑锁 | 防止多窗口编辑 | V2.0 | 📝 待开发 |
| 资产校验 | 防止道具双花 | V2.0 | 📝 待开发 |

---

## 三、【V2.0】格栅系统规格

### 3.1 网格配置

| 参数 | 值 | 说明 |
|------|-----|------|
| gridCols | 12 | 网格列数 |
| gridRows | 10 | 网格行数 |
| cellSize | 64px | 单格尺寸 |
| 画布宽度 | 768px | 12 × 64 |
| 画布高度 | 640px | 10 × 64 |

### 3.2 物品放置规则

| 规则 | 说明 |
|------|------|
| 网格对齐 | 物品必须对齐到网格 |
| 边界限制 | 物品不能超出网格边界 |
| 冲突检测 | 物品占用格不能重叠 |
| 旋转处理 | 90°旋转后交换宽高 |

### 3.3 编辑模式

| 模式 | 特征 |
|------|------|
| 浏览模式 | 物品正常显示，可点击互动 |
| 装修模式 | 显示网格、物品可拖拽、非交互物品半透明 |

---

## 四、装饰品类型

| 类型 | 代码 | 说明 | 可放格数 |
|------|------|------|----------|
| 家具 | FURNITURE | 桌椅、柜子等 | 1-4 |
| 植物 | PLANT | 花草树木 | 1-2 |
| 地板 | FLOORING | 地面装饰 | 1 |
| 壁纸 | WALLPAPER | 背景装饰 | N/A |
| 纪念品展示 | SOUVENIR_DISPLAY | 旅行纪念品 | 1-2 |

---

## 五、【V2.0】Buff 类型

| Buff Code | 名称 | 效果 | 稀有度要求 |
|-----------|------|------|-----------|
| rest_reduce | 缩短休息 | 旅行归来休息时间 -10% | ≥3 |
| luck_boost | 幸运提升 | 发现稀有物品概率 +5% | ≥4 |
| visitor_bonus | 访客奖励 | 互动友好度 +10% | ≥3 |
| treasure_boost | 寻宝提升 | 寻宝奖励 +20% | ≥5 |

---

## 六、【V2.0】寻宝奖励规格

| 奖励类型 | 概率 | 内容 | 数量范围 |
|----------|------|------|----------|
| 代币 (token) | 50% | ZETA | 1-10 |
| 素材 (material) | 35% | 食物/物资 | 1-3 |
| 装饰品 (decoration) | 15% | 随机装饰 | 1 |

### 6.1 寻宝限制

| 规则 | 值 |
|------|-----|
| 每日次数 | 每家园每访客 1 次 |
| 刷新时间 | 每日 00:00 |
| 前置条件 | 需好友关系 |

---

## 七、场景类型

| 类型 | 代码 | 说明 |
|------|------|------|
| 庭院 | yard | 户外场景 |
| 室内 | indoor | 室内场景 |

---

## 八、数据规格

### 8.1 核心表

| 表 | 说明 | 版本 |
|------|------|------|
| Decoration | 装饰品元数据定义 | V1.0 / V2.0增强 |
| UserDecoration | 用户装饰品库存 | V1.0 |
| RoomLayout | 布局配置 | V1.0 / V2.0增强 |
| PlacedItem | 已放置物品 | V1.0 / V2.0增强 |
| RoomLayoutSnapshot | 布局快照 | V1.0 |
| Gift | 礼物记录 | V1.0 |
| Photo | 照片 | V1.0 |
| VisitorMessage | 访客留言 | V1.0 |
| **DailyTreasure** | 每日寻宝记录 | **V2.0** |
| **OfflineBonus** | 离线收益记录 | **V2.0** |

### 8.2 PlacedItem 字段（V2.0）

| 字段 | 类型 | 说明 |
|------|------|------|
| gridX | Int | 网格坐标 X (0-11) |
| gridY | Int | 网格坐标 Y (0-9) |
| scale | Float | 缩放比例 |
| rotation | Int | 旋转角度 (0/90/180/270) |
| zIndex | Int | 层级 |
| state | String | 天气状态 (normal/rain/snow) |

---

## 九、接口约定

### 9.1 路由前缀

| 模块 | 前缀 |
|------|------|
| 家园 | `/api/homestead` |
| 花园 | `/api/garden` |

### 9.2 响应格式

```typescript
interface HomesteadResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
}
```

---

## 十、WebSocket 事件

| 事件 | 说明 | 版本 |
|------|------|------|
| `garden:visit:request` | 访问请求 | V1.0 |
| `garden:visitor:entered` | 访客进入 | V1.0 |
| `garden:visitor:left` | 访客离开 | V1.0 |
| `garden:interaction` | 互动事件 | V1.0 |
| **`garden:treasure:found`** | 寻宝成功 | **V2.0** |

---

## 十一、性能要求

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 布局加载 | < 300ms | 含装饰资源 |
| 保存布局 | < 200ms | 含快照创建、冲突检测 |
| 访客列表 | < 100ms | 实时更新 |
| 舒适度计算 | < 50ms | 缓存结果 |

---

## 十二、代码实现

### 12.1 后端文件

| 文件 | 说明 | 版本 |
|------|------|------|
| `homestead.routes.ts` | 家园主API | V1.0 / V2.0增强 |
| `garden.routes.ts` | 花园访问API | V1.0 / V2.0增强 |
| `decoration.service.ts` | 装饰品服务 | V1.0 / V2.0增强 |
| `photo.service.ts` | 相册服务 | V1.0 |
| `achievement.service.ts` | 成就服务 | V1.0 |
| **`comfort.service.ts`** | 舒适度服务 | **V2.0** |
| **`treasure.service.ts`** | 寻宝服务 | **V2.0** |
| **`offline.service.ts`** | 离线收益服务 | **V2.0** |

### 12.2 前端文件

| 文件 | 说明 | 版本 |
|------|------|------|
| `GardenScene.tsx` | 家园场景 | V1.0 / V2.0增强 |
| `DraggableItem.tsx` | 可拖拽物品 | V1.0 / V2.0增强 |
| **`GridOverlay.tsx`** | 网格覆盖层 | **V2.0** |
| **`useGridEditor.ts`** | 网格编辑 Hook | **V2.0** |

---

## 十三、变更记录

| 日期 | 版本 | 内容 |
|------|------|------|
| 2026-01-14 | 1.0 | 初始模块规格 |
| 2026-01-14 | 2.0 | V2.0 增强：格栅系统、舒适度、Buff、寻宝、离线收益 |

---
