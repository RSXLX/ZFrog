---
status: 已审核
version: 1.0
last_updated: 2026-01-14
reviewer: AI (根据实际代码检查)
---

# 好友系统模块规格

> 本文档定义好友系统模块的技术规格和实现约定。

---

## 一、模块概述

好友系统是 ZetaFrog 社交互动的核心模块，管理玩家间的好友关系和互动。

| 属性 | 值 |
|------|------|
| 模块名称 | 好友系统 (Friend System) |
| 依赖模块 | 青蛙NFT系统、WebSocket服务 |
| 技术栈 | Node.js + TypeScript + Prisma + WebSocket |

---

## 二、核心功能

### 2.1 好友管理

| 功能点 | 说明 | 优先级 | 状态 |
|--------|------|--------|------|
| 发送好友请求 | 支持地址/TokenId两种方式 | P0 | ✅ 已实现 |
| 接受/拒绝请求 | 响应好友请求 | P0 | ✅ 已实现 |
| 好友列表 | 含在线状态和最新互动 | P0 | ✅ 已实现 |
| 删除好友 | 级联删除互动记录 | P0 | ✅ 已实现 |

### 2.2 互动系统

| 功能点 | 说明 | 优先级 | 状态 |
|--------|------|--------|------|
| 互动记录 | 支持6种互动类型 | P0 | ✅ 已实现 |
| 互动历史 | 分页查询互动记录 | P1 | ✅ 已实现 |
| 实时通知 | WebSocket推送 | P0 | ✅ 已实现 |

---

## 三、业务规则

### 3.1 好友请求规则

| 规则 | 说明 |
|------|------|
| 不能加自己 | requesterId ≠ addresseeId |
| 唯一关系 | 双方只能有一个好友关系记录 |
| 状态恢复 | 已拒绝的关系可重新发起 |

### 3.2 好友状态

| 状态 | 说明 | 可执行操作 |
|------|------|------------|
| Pending | 待处理 | 接受/拒绝 |
| Accepted | 已接受 | 互动/删除 |
| Declined | 已拒绝 | 重新发起 |
| Blocked | 已拉黑 | 无 |

### 3.3 互动类型

| 类型 | 代码 | 说明 | 使用场景 |
|------|------|------|----------|
| 访问 | Visit | 访问好友家园 | 家园系统 |
| 喂食 | Feed | 给好友青蛙喂食 | 家园系统 |
| 玩耍 | Play | 与好友青蛙玩耍 | 家园系统 |
| 送礼 | Gift | 赠送礼物 | 家园系统 |
| 消息 | Message | 发送消息 | 家园留言板 |
| 旅行 | Travel | 结伴旅行开始/完成 | 旅行系统 |

> **Travel 类型说明**：结伴旅行开始时由 `travel.routes.ts` 创建，旅行完成时由 `travelProcessor.ts` 创建，并通过 WebSocket 通知好友。

---

## 四、数据规格

### 4.1 Friendship 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| requesterId | Int | 发起者青蛙 ID |
| addresseeId | Int | 接收者青蛙 ID |
| status | FriendshipStatus | 当前状态 |
| createdAt | DateTime | 创建时间 |
| updatedAt | DateTime | 更新时间 |

### 4.2 FriendInteraction 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| friendshipId | Int | 好友关系 ID |
| actorId | Int | 执行者青蛙 ID |
| type | InteractionType | 互动类型 |
| message | String? | 互动消息 |
| metadata | Json? | 附加数据 |
| likesCount | Int | 点赞数 |
| createdAt | DateTime | 创建时间 |

---

## 五、接口约定

### 5.1 路由前缀

| 模块 | 前缀 |
|------|------|
| 好友 | `/api/friends` |

### 5.2 响应格式

**成功响应**
```json
{
  "id": 1,
  "status": "Accepted",
  ...
}
```

**错误响应**
```json
{
  "error": "错误描述"
}
```

---

## 六、WebSocket 事件

| 事件 | 触发时机 | 接收者 |
|------|----------|--------|
| `friend:request:received` | 收到请求 | 接收者 |
| `friend:request:status` | 状态变更 | 双方 |
| `friend:interaction` | 新互动 | 对方 |
| `friend:removed` | 删除好友 | 双方 |

---

## 七、性能要求

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 好友列表响应 | < 200ms | 缓存在线状态 |
| 互动创建响应 | < 100ms | 异步推送通知 |
| WebSocket 延迟 | < 500ms | 实时性要求 |

---

## 八、安全要求

| 要求 | 说明 |
|------|------|
| 授权验证 | 操作前验证好友关系归属 |
| 输入验证 | 验证 TokenId、状态等参数 |
| 防刷保护 | Rate Limiting 限制请求频率 |

---

## 九、代码实现

### 9.1 后端文件

| 文件 | 行数 | 说明 |
|------|------|------|
| `friends.routes.ts` | 419 | API 路由 |
| `websocket/index.ts` | - | WebSocket 通知 |

### 9.2 前端组件

| 组件 | 说明 |
|------|------|
| `FriendsList.tsx` | 好友列表 |
| `FriendRequests.tsx` | 请求列表 |
| `AddFriend.tsx` | 添加好友 |
| `AddFriendByWallet.tsx` | 按地址添加 |
| `FriendInteraction.tsx` | 互动组件 |

---

## 十、变更记录

| 日期 | 版本 | 内容 |
|------|------|------|
| 2026-01-14 | 1.0 | 初始模块规格 |
| 2026-01-14 | 1.1 | 更新 Travel 互动类型说明，明确使用场景 |

---
