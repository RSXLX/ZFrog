
# ğŸ¨ ZetaFrog NFT å›¾ç‰‡ç”ŸæˆåŠŸèƒ½ - å®Œæ•´å¼€å‘æ–‡æ¡£ï¼ˆé˜¿é‡Œäº‘ç™¾ç‚¼ç‰ˆï¼‰

## ğŸ“‹ æ–‡æ¡£æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ZetaFrog NFT å›¾ç‰‡ç”Ÿæˆç³»ç»Ÿ (é˜¿é‡Œäº‘ç™¾ç‚¼)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ¯ ç›®æ ‡ï¼šä¸ºæ—…è¡Œçºªå¿µå“ NFT ç”Ÿæˆç‹¬ç‰¹çš„ AI è‰ºæœ¯å›¾ç‰‡            â”‚
â”‚                                                             â”‚
â”‚  ğŸ“Š å¼€å‘éš¾åº¦ï¼šâ­â­â­â˜†â˜† (ä¸­ç­‰åæ˜“)                           â”‚
â”‚  â±ï¸ é¢„ä¼°å·¥æ—¶ï¼š3-4 å¤©ï¼ˆå…¨åŠŸèƒ½å®ç°ï¼‰                          â”‚
â”‚                                                             â”‚
â”‚  âœ… æ¨èæ¨¡å‹ï¼šwan2.2-t2i-flash                              â”‚
â”‚     â€¢ é€Ÿåº¦ï¼šæ¯” 2.1 ç‰ˆæœ¬å¿« 50%                               â”‚
â”‚     â€¢ ä»·æ ¼ï¼š0.04 å…ƒ/å¼ ï¼ˆæœ€ä¾¿å®œï¼‰                            â”‚
â”‚     â€¢ æ•ˆæœï¼šç¨³å®šæ€§ä¸æˆåŠŸç‡å…¨é¢æå‡                          â”‚
â”‚                                                             â”‚
â”‚  ğŸ’° æˆæœ¬ä¼°ç®—ï¼ˆæ¯æœˆ 10,000 å¼ ï¼‰ï¼š                            â”‚
â”‚     â€¢ å›¾ç‰‡ç”Ÿæˆï¼š10,000 Ã— Â¥0.04 = Â¥400                      â”‚
â”‚     â€¢ IPFS å­˜å‚¨ï¼šå…è´¹é¢åº¦ / $20 æœˆ                          â”‚
â”‚     â€¢ æ€»è®¡ï¼šçº¦ Â¥500-600/æœˆ                                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. æ¨¡å‹é€‰å‹å¯¹æ¯”

### 1.1 é€šä¹‰ä¸‡ç›¸æ–‡ç”Ÿå›¾æ¨¡å‹å¯¹æ¯”

| æ¨¡å‹åç§° | ç‰ˆæœ¬ | é€Ÿåº¦ | ä»·æ ¼ | åˆ†è¾¨ç‡èŒƒå›´ | æ¨èåœºæ™¯ |
|---------|------|------|------|-----------|---------|
| **wan2.2-t2i-flash** | æé€Ÿç‰ˆ | âš¡âš¡âš¡âš¡âš¡ | **0.04å…ƒ/å¼ ** | 512-1440px | **âœ… é¦–é€‰æ¨è** |
| wan2.2-t2i-plus | ä¸“ä¸šç‰ˆ | âš¡âš¡âš¡ | 0.08å…ƒ/å¼  | 512-1440px | é«˜è´¨é‡éœ€æ±‚ |
| wan2.5-t2i-preview | é¢„è§ˆç‰ˆ | âš¡âš¡ | 0.10å…ƒ/å¼  | 768-2700px | è¶…é•¿å°ºå¯¸ |
| wanx2.1-t2i-turbo | æé€Ÿç‰ˆ | âš¡âš¡âš¡âš¡ | 0.06å…ƒ/å¼  | 512-1440px | å¤‡é€‰ |
| wanx-v1 | V1ç‰ˆ | âš¡âš¡ | 0.16å…ƒ/å¼  | 720-1280px | ä¸æ¨è |

### 1.2 æ¨èé…ç½®

```typescript
// æ¨èé…ç½®ï¼šwan2.2-t2i-flash
const RECOMMENDED_CONFIG = {
  model: 'wan2.2-t2i-flash',     // æœ€å¿«æœ€ä¾¿å®œ
  size: '512*512',               // NFT æ ‡å‡†å°ºå¯¸
  n: 1,                          // æ¯æ¬¡ç”Ÿæˆ1å¼ 
  prompt_extend: true,           // å¼€å¯æ™ºèƒ½æ”¹å†™
  watermark: false,              // ä¸æ·»åŠ æ°´å°
};
```

---

## 2. API è°ƒç”¨æµç¨‹

### 2.1 è°ƒç”¨æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å¼‚æ­¥ API è°ƒç”¨æµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. æäº¤ä»»åŠ¡  â”‚ --> â”‚ 2. è·å–     â”‚ --> â”‚ 3. è½®è¯¢     â”‚  â”‚
â”‚  â”‚ POST /...   â”‚     â”‚ task_id     â”‚     â”‚ ä»»åŠ¡çŠ¶æ€    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                   â”‚        â”‚
â”‚                                                   â–¼        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 6. æ›´æ–°NFT  â”‚ <-- â”‚ 5. ä¸Šä¼ IPFS â”‚ <-- â”‚ 4. è·å–     â”‚  â”‚
â”‚  â”‚ å…ƒæ•°æ®      â”‚     â”‚             â”‚     â”‚ å›¾ç‰‡URL     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  â±ï¸ å…¸å‹è€—æ—¶ï¼š15-30ç§’ï¼ˆflashæ¨¡å‹ï¼‰                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 API ç«¯ç‚¹

| æ­¥éª¤ | æ–¹æ³• | ç«¯ç‚¹ |
|------|------|------|
| åˆ›å»ºä»»åŠ¡ | POST | `https://dashscope.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis` |
| æŸ¥è¯¢ç»“æœ | GET | `https://dashscope.aliyuncs.com/api/v1/tasks/{task_id}` |

---

## 3. æç¤ºè¯ï¼ˆPromptï¼‰è®¾è®¡ç³»ç»Ÿ

### 3.1 ZetaFrog ä¸“ç”¨æç¤ºè¯æ¨¡æ¿

```typescript
// src/config/prompt-templates.ts

/**
 * ZetaFrog æç¤ºè¯æ„å»ºç³»ç»Ÿ
 * 
 * è®¾è®¡åŸåˆ™ï¼š
 * 1. ç»Ÿä¸€å“ç‰Œé£æ ¼ - å¡é€šã€å¯çˆ±ã€æ˜äº®
 * 2. çªå‡ºè·¨é“¾ä¸»é¢˜ - åŒºå—é“¾å…ƒç´ 
 * 3. ç¨€æœ‰åº¦åŒºåˆ† - è§†è§‰å¤æ‚åº¦é€’å¢
 */

// åŸºç¡€é£æ ¼å‰ç¼€ï¼ˆæ‰€æœ‰å›¾ç‰‡å…±ç”¨ï¼‰
export const STYLE_PREFIX = `
cute kawaii cartoon style, 
chibi frog character,
soft rounded shapes,
bright vibrant colors,
clean digital illustration,
transparent background,
high quality, 4K detailed
`.trim().replace(/\s+/g, ' ');

// è´Ÿé¢æç¤ºè¯ï¼ˆé¿å…ç”Ÿæˆä¸è‰¯å†…å®¹ï¼‰
export const NEGATIVE_PROMPT = `
realistic, photorealistic, 3d render,
dark, gloomy, scary, horror,
blurry, low quality, distorted,
text, watermark, signature,
bad anatomy, deformed,
multiple frogs, crowded
`.trim().replace(/\s+/g, ' ');

// çºªå¿µå“ç±»å‹é…ç½®
export const SOUVENIR_PROMPTS: Record<string, SouvenirPromptConfig> = {
  ETHEREUM_POSTCARD: {
    name: 'Ethereum Postcard',
    nameZh: 'ä»¥å¤ªåŠæ˜ä¿¡ç‰‡',
    basePrompt: 'vintage postcard design, Ethereum diamond logo, blockchain network background, stamp corner decoration',
    colors: 'purple and blue gradient, silver accents',
    rarityEnhance: {
      COMMON: 'simple flat design',
      UNCOMMON: 'subtle glow effects, soft shadows',
      RARE: 'holographic shimmer, metallic accents',
      EPIC: 'golden frame, aurora glow, sparkles',
      LEGENDARY: 'rainbow holographic, crystal elements, divine light rays',
    }
  },

  GAS_FEE_RECEIPT: {
    name: 'Gas Fee Receipt',
    nameZh: 'Gasè´¹æ”¶æ®',
    basePrompt: 'paper receipt design, gas pump icon, transaction data display, crypto symbols',
    colors: 'warm yellow and orange, white paper texture',
    rarityEnhance: {
      COMMON: 'basic receipt paper',
      UNCOMMON: 'decorated borders, cute doodles',
      RARE: 'golden seal stamp, premium paper texture',
      EPIC: 'holographic receipt, glowing numbers',
      LEGENDARY: 'mythical scroll, floating in gas clouds, cosmic energy',
    }
  },

  BLOCKCHAIN_SNOWGLOBE: {
    name: 'Blockchain Snowglobe',
    nameZh: 'åŒºå—é“¾æ°´æ™¶çƒ',
    basePrompt: 'magical snow globe, miniature blockchain city inside, digital snowflakes falling, glowing base',
    colors: 'crystal blue, white sparkles, soft purple glow',
    rarityEnhance: {
      COMMON: 'simple glass sphere, basic scene',
      UNCOMMON: 'animated snow particles, multiple buildings',
      RARE: 'magical aurora inside, floating crypto symbols',
      EPIC: 'enchanted globe, swirling energy vortex',
      LEGENDARY: 'cosmic globe, entire universe inside, rainbow nebula',
    }
  },

  CRYPTO_STAMP: {
    name: 'Crypto Stamp',
    nameZh: 'åŠ å¯†é‚®ç¥¨',
    basePrompt: 'collectible postage stamp, perforated edges, denomination value, blockchain themed artwork',
    colors: 'vintage sepia, royal purple, gold foil',
    rarityEnhance: {
      COMMON: 'standard stamp design',
      UNCOMMON: 'commemorative edition mark',
      RARE: 'metallic foil printing, embossed details',
      EPIC: 'holographic stamp, 3D depth effect',
      LEGENDARY: 'animated elements, ultra-rare limited edition',
    }
  },

  CHAIN_COMPASS: {
    name: 'Chain Compass',
    nameZh: 'é“¾ä¸ŠæŒ‡å—é’ˆ',
    basePrompt: 'magical compass, ornate design, multiple chain indicators, glowing needle, map background',
    colors: 'brass gold, deep blue, emerald green',
    rarityEnhance: {
      COMMON: 'basic wooden compass',
      UNCOMMON: 'brass compass with engravings',
      RARE: 'golden compass, gem-studded face',
      EPIC: 'magical floating holographic display',
      LEGENDARY: 'ancient artifact, reality-bending effects, cosmic symbols',
    }
  },

  DEFI_TREASURE_MAP: {
    name: 'DeFi Treasure Map',
    nameZh: 'DeFiè—å®å›¾',
    basePrompt: 'ancient treasure map, aged parchment paper, protocol landmarks, yield farming spots, X marks the spot',
    colors: 'parchment brown, ink black, gold highlights, red X',
    rarityEnhance: {
      COMMON: 'simple hand-drawn routes',
      UNCOMMON: 'multiple treasure locations, detailed paths',
      RARE: 'hidden secrets revealed, glowing trails',
      EPIC: 'animated path indicators, magical symbols',
      LEGENDARY: 'legendary map showing all DeFi treasures, cosmic overlay',
    }
  },

  NFT_POLAROID: {
    name: 'NFT Polaroid',
    nameZh: 'NFTæ‹ç«‹å¾—',
    basePrompt: 'Polaroid instant photo, white frame, captured crypto moment, handwritten caption, date stamp',
    colors: 'white frame, vibrant photo colors, vintage filter',
    rarityEnhance: {
      COMMON: 'standard polaroid',
      UNCOMMON: 'special filter effects, color enhancement',
      RARE: 'golden frame, memorable scene',
      EPIC: 'animated living memory, sparkle effects',
      LEGENDARY: 'multidimensional showing parallel realities, cosmic frame',
    }
  },

  SMART_CONTRACT_SCROLL: {
    name: 'Smart Contract Scroll',
    nameZh: 'æ™ºèƒ½åˆçº¦å·è½´',
    basePrompt: 'ancient scroll, rolled parchment, glowing code text, magical seals, contract symbols',
    colors: 'ancient gold, magical blue glow, code green',
    rarityEnhance: {
      COMMON: 'basic scroll with code snippets',
      UNCOMMON: 'decorated scroll, syntax highlighting',
      RARE: 'enchanted scroll, animated code',
      EPIC: 'powerful scroll, reality-altering runes',
      LEGENDARY: 'primordial scroll, genesis contract, divine light',
    }
  },

  CROSS_CHAIN_PORTAL: {
    name: 'Cross-chain Portal',
    nameZh: 'è·¨é“¾ä¼ é€é—¨',
    basePrompt: 'mystical portal, swirling energy vortex, chain symbols around, dimensional rift, energy streams',
    colors: 'void purple, energy cyan, portal orange, star white',
    rarityEnhance: {
      COMMON: 'small portal, single destination',
      UNCOMMON: 'medium portal, multiple chain connections',
      RARE: 'large stable wormhole, bright energy',
      EPIC: 'massive portal, cosmic energy flow',
      LEGENDARY: 'ultimate portal connecting all realities, rainbow cosmic energy',
    }
  },
};

// é“¾ä¸»é¢˜é…ç½®
export const CHAIN_THEMES: Record<number, ChainTheme> = {
  1: {
    name: 'Ethereum',
    symbol: 'ETH',
    colors: 'purple and blue, silver diamond',
    elements: 'Ethereum diamond logo, purple energy waves',
  },
  56: {
    name: 'BNB Chain',
    symbol: 'BNB',
    colors: 'golden yellow, warm orange',
    elements: 'BNB coin, golden glow',
  },
  137: {
    name: 'Polygon',
    symbol: 'MATIC',
    colors: 'purple gradient, violet',
    elements: 'polygon shapes, purple energy',
  },
  8453: {
    name: 'Base',
    symbol: 'ETH',
    colors: 'blue, clean white',
    elements: 'Base logo, minimalist design',
  },
  7001: {
    name: 'ZetaChain',
    symbol: 'ZETA',
    colors: 'green and teal, omnichain glow',
    elements: 'Zeta symbol, cross-chain bridges, universal connection',
  },
};

// ç±»å‹å®šä¹‰
interface SouvenirPromptConfig {
  name: string;
  nameZh: string;
  basePrompt: string;
  colors: string;
  rarityEnhance: Record<string, string>;
}

interface ChainTheme {
  name: string;
  symbol: string;
  colors: string;
  elements: string;
}
```

### 3.2 Prompt æ„å»ºæœåŠ¡

```typescript
// src/services/prompt-builder.service.ts

import {
  STYLE_PREFIX,
  NEGATIVE_PROMPT,
  SOUVENIR_PROMPTS,
  CHAIN_THEMES,
} from '../config/prompt-templates';

export interface PromptBuildInput {
  souvenirType: string;        // çºªå¿µå“ç±»å‹
  rarity: string;              // ç¨€æœ‰åº¦
  chainId?: number;            // é“¾ IDï¼ˆå¯é€‰ï¼‰
  customElements?: string[];   // è‡ªå®šä¹‰å…ƒç´ 
}

export interface BuiltPrompt {
  prompt: string;
  negative_prompt: string;
}

export class PromptBuilderService {
  /**
   * æ„å»ºå®Œæ•´çš„å›¾ç‰‡ç”Ÿæˆ Prompt
   */
  buildPrompt(input: PromptBuildInput): BuiltPrompt {
    const souvenirConfig = SOUVENIR_PROMPTS[input.souvenirType];
    
    if (!souvenirConfig) {
      throw new Error(`Unknown souvenir type: ${input.souvenirType}`);
    }

    const parts: string[] = [];

    // 1. é£æ ¼å‰ç¼€
    parts.push(STYLE_PREFIX);

    // 2. çºªå¿µå“åŸºç¡€æè¿°
    parts.push(souvenirConfig.basePrompt);

    // 3. é¢œè‰²æ–¹æ¡ˆ
    parts.push(souvenirConfig.colors);

    // 4. ç¨€æœ‰åº¦å¢å¼º
    const rarityEnhance = souvenirConfig.rarityEnhance[input.rarity];
    if (rarityEnhance) {
      parts.push(rarityEnhance);
    }

    // 5. é“¾ä¸»é¢˜ï¼ˆå¦‚æœæŒ‡å®šï¼‰
    if (input.chainId && CHAIN_THEMES[input.chainId]) {
      const chainTheme = CHAIN_THEMES[input.chainId];
      parts.push(`${chainTheme.name} blockchain themed`);
      parts.push(chainTheme.colors);
      parts.push(chainTheme.elements);
    }

    // 6. è‡ªå®šä¹‰å…ƒç´ 
    if (input.customElements?.length) {
      parts.push(...input.customElements);
    }

    // 7. è´¨é‡å…³é”®è¯
    parts.push('masterpiece', 'best quality', 'highly detailed');

    return {
      prompt: parts.join(', '),
      negative_prompt: NEGATIVE_PROMPT,
    };
  }

  /**
   * æ„å»ºç®€åŒ–çš„ä¸­æ–‡ Promptï¼ˆåˆ©ç”¨æ™ºèƒ½æ”¹å†™åŠŸèƒ½ï¼‰
   * 
   * æ³¨æ„ï¼šå¼€å¯ prompt_extend=true æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ç®€çŸ­çš„ä¸­æ–‡æè¿°ï¼Œ
   * ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰©å±•ä¸ºè¯¦ç»†çš„è‹±æ–‡æç¤ºè¯
   */
  buildSimplePrompt(input: PromptBuildInput): BuiltPrompt {
    const souvenirConfig = SOUVENIR_PROMPTS[input.souvenirType];
    
    if (!souvenirConfig) {
      throw new Error(`Unknown souvenir type: ${input.souvenirType}`);
    }

    // ä½¿ç”¨ç®€æ´çš„ä¸­æ–‡æè¿°ï¼Œè®© AI æ™ºèƒ½æ‰©å±•
    const rarityDesc = this.getRarityDescription(input.rarity);
    const chainDesc = input.chainId ? this.getChainDescription(input.chainId) : '';

    const prompt = `
      å¯çˆ±å¡é€šé£æ ¼çš„${souvenirConfig.nameZh}ï¼Œ
      ${rarityDesc}æ•ˆæœï¼Œ
      ${chainDesc}
      æ˜äº®çš„è‰²å½©ï¼Œç²¾è‡´çš„ç»†èŠ‚ï¼Œ
      é€æ˜èƒŒæ™¯ï¼Œé«˜æ¸…ç”»è´¨
    `.trim().replace(/\s+/g, ' ');

    return {
      prompt,
      negative_prompt: 'æ¨¡ç³Šã€ä½è´¨é‡ã€å˜å½¢ã€æ–‡å­—ã€æ°´å°ã€ææ€–ã€é»‘æš—',
    };
  }

  private getRarityDescription(rarity: string): string {
    const descriptions: Record<string, string> = {
      COMMON: 'ç®€æ´',
      UNCOMMON: 'ç²¾ç¾',
      RARE: 'é—ªè€€çš„',
      EPIC: 'åä¸½çš„é­”æ³•',
      LEGENDARY: 'ä¼ å¥‡çš„å®‡å®™çº§',
    };
    return descriptions[rarity] || 'ç²¾ç¾';
  }

  private getChainDescription(chainId: number): string {
    const chain = CHAIN_THEMES[chainId];
    return chain ? `${chain.name}åŒºå—é“¾ä¸»é¢˜ï¼Œ` : '';
  }
}
```

---

## 4. å›¾ç‰‡ç”ŸæˆæœåŠ¡ï¼ˆæ ¸å¿ƒå®ç°ï¼‰

### 4.1 é˜¿é‡Œäº‘ç™¾ç‚¼ API æœåŠ¡

```typescript
// src/services/dashscope-image.service.ts

import axios, { AxiosInstance } from 'axios';

// API é…ç½®
const API_CONFIG = {
  baseUrl: 'https://dashscope.aliyuncs.com/api/v1',
  createTaskEndpoint: '/services/aigc/text2image/image-synthesis',
  queryTaskEndpoint: '/tasks',
};

// æ¨¡å‹é…ç½®
export const MODEL_CONFIG = {
  // âœ… æ¨èï¼šæœ€å¿«æœ€ä¾¿å®œ
  FLASH: {
    model: 'wan2.2-t2i-flash',
    price: 0.04,  // å…ƒ/å¼ 
    speed: 'âš¡âš¡âš¡âš¡âš¡',
    description: 'æé€Ÿç‰ˆï¼Œé€Ÿåº¦æœ€å¿«ï¼Œæ€§ä»·æ¯”æœ€é«˜',
  },
  // é«˜è´¨é‡é€‰æ‹©
  PLUS: {
    model: 'wan2.2-t2i-plus',
    price: 0.08,
    speed: 'âš¡âš¡âš¡',
    description: 'ä¸“ä¸šç‰ˆï¼Œè´¨é‡æ›´é«˜',
  },
};

// å›¾ç‰‡å°ºå¯¸é…ç½®
export const SIZE_OPTIONS = {
  SQUARE_512: '512*512',     // NFT æ ‡å‡†
  SQUARE_1024: '1024*1024',  // é«˜æ¸…
  PORTRAIT: '720*1280',      // ç«–ç‰ˆ
  LANDSCAPE: '1280*720',     // æ¨ªç‰ˆ
};

// è¯·æ±‚å‚æ•°æ¥å£
export interface GenerateImageRequest {
  prompt: string;
  negative_prompt?: string;
  model?: string;
  size?: string;
  n?: number;
  seed?: number;
  prompt_extend?: boolean;
  watermark?: boolean;
}

// ä»»åŠ¡ç»“æœæ¥å£
export interface TaskResult {
  task_id: string;
  task_status: 'PENDING' | 'RUNNING' | 'SUCCEEDED' | 'FAILED';
  results?: Array<{
    url: string;
    orig_prompt?: string;
    actual_prompt?: string;
  }>;
  task_metrics?: {
    TOTAL: number;
    SUCCEEDED: number;
    FAILED: number;
  };
  code?: string;
  message?: string;
}

export class DashScopeImageService {
  private client: AxiosInstance;
  private apiKey: string;

  constructor(apiKey: string) {
    this.apiKey = apiKey;
    this.client = axios.create({
      baseURL: API_CONFIG.baseUrl,
      timeout: 120000, // 2åˆ†é’Ÿè¶…æ—¶
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
    });
  }

  /**
   * åˆ›å»ºå›¾ç‰‡ç”Ÿæˆä»»åŠ¡ï¼ˆå¼‚æ­¥ï¼‰
   */
  async createTask(request: GenerateImageRequest): Promise<string> {
    const payload = {
      model: request.model || MODEL_CONFIG.FLASH.model,
      input: {
        prompt: request.prompt,
        negative_prompt: request.negative_prompt || '',
      },
      parameters: {
        size: request.size || SIZE_OPTIONS.SQUARE_512,
        n: request.n || 1,
        seed: request.seed,
        prompt_extend: request.prompt_extend ?? true,
        watermark: request.watermark ?? false,
      },
    };

    console.log(`[DashScope] åˆ›å»ºä»»åŠ¡ï¼Œæ¨¡å‹: ${payload.model}`);
    console.log(`[DashScope] Prompt: ${request.prompt.substring(0, 100)}...`);

    const response = await this.client.post(
      API_CONFIG.createTaskEndpoint,
      payload,
      {
        headers: {
          'X-DashScope-Async': 'enable', // å¿…é¡»ï¼šå¼‚æ­¥æ¨¡å¼
        },
      }
    );

    if (response.data.output?.task_id) {
      console.log(`[DashScope] ä»»åŠ¡åˆ›å»ºæˆåŠŸ: ${response.data.output.task_id}`);
      return response.data.output.task_id;
    }

    throw new Error(response.data.message || 'Failed to create task');
  }

  /**
   * æŸ¥è¯¢ä»»åŠ¡ç»“æœ
   */
  async queryTask(taskId: string): Promise<TaskResult> {
    const response = await this.client.get(
      `${API_CONFIG.queryTaskEndpoint}/${taskId}`
    );

    return {
      task_id: response.data.output?.task_id,
      task_status: response.data.output?.task_status,
      results: response.data.output?.results,
      task_metrics: response.data.output?.task_metrics,
      code: response.data.output?.code,
      message: response.data.output?.message,
    };
  }

  /**
   * ç­‰å¾…ä»»åŠ¡å®Œæˆï¼ˆè½®è¯¢ï¼‰
   */
  async waitForCompletion(
    taskId: string,
    options: {
      maxAttempts?: number;
      intervalMs?: number;
      onProgress?: (status: string, attempt: number) => void;
    } = {}
  ): Promise<TaskResult> {
    const { 
      maxAttempts = 60,      // æœ€å¤šç­‰å¾… 2 åˆ†é’Ÿ
      intervalMs = 2000,     // æ¯ 2 ç§’æŸ¥è¯¢ä¸€æ¬¡
      onProgress 
    } = options;

    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
      const result = await this.queryTask(taskId);

      onProgress?.(result.task_status, attempt);

      if (result.task_status === 'SUCCEEDED') {
        console.log(`[DashScope] ä»»åŠ¡å®Œæˆï¼Œè€—æ—¶çº¦ ${attempt * 2} ç§’`);
        return result;
      }

      if (result.task_status === 'FAILED') {
        throw new Error(result.message || 'Task failed');
      }

      // ç»§ç»­ç­‰å¾…
      await this.sleep(intervalMs);
    }

    throw new Error('Task timeout');
  }

  /**
   * ä¸€é”®ç”Ÿæˆå›¾ç‰‡ï¼ˆåˆ›å»ºä»»åŠ¡ + ç­‰å¾…å®Œæˆï¼‰
   */
  async generateImage(request: GenerateImageRequest): Promise<{
    imageUrl: string;
    originalPrompt: string;
    expandedPrompt?: string;
  }> {
    // 1. åˆ›å»ºä»»åŠ¡
    const taskId = await this.createTask(request);

    // 2. ç­‰å¾…å®Œæˆ
    const result = await this.waitForCompletion(taskId, {
      onProgress: (status, attempt) => {
        console.log(`[DashScope] çŠ¶æ€: ${status}, è½®è¯¢æ¬¡æ•°: ${attempt}`);
      },
    });

    // 3. æå–ç»“æœ
    if (!result.results || result.results.length === 0) {
      throw new Error('No image generated');
    }

    const imageResult = result.results[0];
    
    return {
      imageUrl: imageResult.url,
      originalPrompt: imageResult.orig_prompt || request.prompt,
      expandedPrompt: imageResult.actual_prompt,
    };
  }

  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

### 4.2 ä½¿ç”¨ç¤ºä¾‹

```typescript
// ä½¿ç”¨ç¤ºä¾‹
import { DashScopeImageService, MODEL_CONFIG, SIZE_OPTIONS } from './dashscope-image.service';
import { PromptBuilderService } from './prompt-builder.service';

async function generateSouvenirImage() {
  const apiKey = process.env.DASHSCOPE_API_KEY!;
  const imageService = new DashScopeImageService(apiKey);
  const promptBuilder = new PromptBuilderService();

  // æ„å»º Prompt
  const { prompt, negative_prompt } = promptBuilder.buildPrompt({
    souvenirType: 'CROSS_CHAIN_PORTAL',
    rarity: 'EPIC',
    chainId: 7001, // ZetaChain
  });

  console.log('ç”Ÿæˆ Prompt:', prompt);

  // ç”Ÿæˆå›¾ç‰‡
  const result = await imageService.generateImage({
    prompt,
    negative_prompt,
    model: MODEL_CONFIG.FLASH.model,  // ä½¿ç”¨æœ€å¿«æœ€ä¾¿å®œçš„æ¨¡å‹
    size: SIZE_OPTIONS.SQUARE_512,
    n: 1,
    prompt_extend: true,  // å¼€å¯æ™ºèƒ½æ”¹å†™
    watermark: false,
  });

  console.log('å›¾ç‰‡ URL:', result.imageUrl);
  console.log('æ‰©å±•å Prompt:', result.expandedPrompt);

  return result;
}
```

---

## 5. å®Œæ•´çš„ NFT å›¾ç‰‡ç¼–æ’æœåŠ¡

```typescript
// src/services/nft-image-orchestrator.service.ts

import { PrismaClient, ImageGenerationStatus } from '@prisma/client';
import { DashScopeImageService, MODEL_CONFIG, SIZE_OPTIONS } from './dashscope-image.service';
import { PromptBuilderService } from './prompt-builder.service';
import { IPFSUploaderService } from './ipfs-uploader.service';
import { ImageProcessorService } from './image-processor.service';

const prisma = new PrismaClient();

export interface GenerateSouvenirImageInput {
  odosId: string;             // é’è›™ ID
  travelId: string;           // æ—…è¡Œ ID
  souvenirId: string;         // çºªå¿µå“ ID
  souvenirType: string;       // çºªå¿µå“ç±»å‹
  rarity: string;             // ç¨€æœ‰åº¦
  chainId?: number;           // é“¾ ID
}

export class NFTImageOrchestratorService {
  private imageService: DashScopeImageService;
  private promptBuilder: PromptBuilderService;
  private ipfsUploader: IPFSUploaderService;
  private imageProcessor: ImageProcessorService;

  constructor() {
    const apiKey = process.env.DASHSCOPE_API_KEY!;
    this.imageService = new DashScopeImageService(apiKey);
    this.promptBuilder = new PromptBuilderService();
    this.ipfsUploader = new IPFSUploaderService();
    this.imageProcessor = new ImageProcessorService();
  }

  /**
   * ç”Ÿæˆçºªå¿µå“ NFT å›¾ç‰‡ï¼ˆå®Œæ•´æµç¨‹ï¼‰
   */
  async generateSouvenirImage(input: GenerateSouvenirImageInput) {
    console.log(`[Orchestrator] å¼€å§‹ç”Ÿæˆ: ${input.souvenirType} - ${input.rarity}`);

    // 1. åˆ›å»ºæ•°æ®åº“è®°å½•
    const record = await this.createRecord(input);

    try {
      // 2. æ„å»º Prompt
      const { prompt, negative_prompt } = this.promptBuilder.buildPrompt({
        souvenirType: input.souvenirType,
        rarity: input.rarity,
        chainId: input.chainId,
      });

      await this.updateRecord(record.id, {
        prompt,
        negativePrompt: negative_prompt,
        status: ImageGenerationStatus.GENERATING,
      });

      // 3. è°ƒç”¨ AI ç”Ÿæˆå›¾ç‰‡
      console.log(`[Orchestrator] è°ƒç”¨ AI ç”Ÿæˆ...`);
      const result = await this.imageService.generateImage({
        prompt,
        negative_prompt,
        model: MODEL_CONFIG.FLASH.model,
        size: SIZE_OPTIONS.SQUARE_512,
        n: 1,
        prompt_extend: true,
        watermark: false,
        seed: this.generateSeed(input),
      });

      await this.updateRecord(record.id, {
        imageUrl: result.imageUrl,
        actualPrompt: result.expandedPrompt,
        status: ImageGenerationStatus.PROCESSING,
        generatedAt: new Date(),
      });

      // 4. ä¸‹è½½å¹¶å¤„ç†å›¾ç‰‡
      console.log(`[Orchestrator] å¤„ç†å›¾ç‰‡...`);
      const processed = await this.imageProcessor.processImage({
        imageUrl: result.imageUrl,
        targetWidth: 512,
        targetHeight: 512,
        format: 'png',
      });

      // 5. ä¸Šä¼ åˆ° IPFS
      console.log(`[Orchestrator] ä¸Šä¼  IPFS...`);
      await this.updateRecord(record.id, {
        status: ImageGenerationStatus.UPLOADING,
      });

      const ipfsResult = await this.ipfsUploader.uploadImage({
        buffer: processed.buffer,
        filename: `zetafrog-${input.souvenirType}-${input.rarity}-${Date.now()}.png`,
      });

      // 6. æ›´æ–°è®°å½•ä¸ºå®Œæˆ
      const finalRecord = await this.updateRecord(record.id, {
        ipfsHash: ipfsResult.ipfsHash,
        ipfsUrl: ipfsResult.ipfsUrl,
        gatewayUrl: ipfsResult.gatewayUrl,
        fileSize: processed.fileSize,
        status: ImageGenerationStatus.COMPLETED,
        uploadedAt: new Date(),
      });

      console.log(`[Orchestrator] âœ… å®Œæˆ: ${ipfsResult.ipfsHash}`);

      return {
        success: true,
        record: finalRecord,
        imageUrl: ipfsResult.gatewayUrl,
        ipfsHash: ipfsResult.ipfsHash,
      };

    } catch (error: any) {
      console.error(`[Orchestrator] âŒ å¤±è´¥: ${error.message}`);

      await this.updateRecord(record.id, {
        status: ImageGenerationStatus.FAILED,
        errorMessage: error.message,
        retryCount: { increment: 1 },
      });

      return {
        success: false,
        error: error.message,
        record,
      };
    }
  }

  /**
   * ç”Ÿæˆå”¯ä¸€ç§å­
   */
  private generateSeed(input: GenerateSouvenirImageInput): number {
    const str = `${input.odosId}-${input.souvenirId}-${Date.now()}`;
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i);
      hash = hash & hash;
    }
    return Math.abs(hash) % 2147483647;
  }

  private async createRecord(input: GenerateSouvenirImageInput) {
    return prisma.souvenirImage.create({
      data: {
        odosId: input.odosId,
        travelId: input.travelId,
        souvenirId: input.souvenirId,
        souvenirType: input.souvenirType,
        souvenirName: `${input.souvenirType}_${input.rarity}`,
        rarity: input.rarity,
        prompt: '',
        seed: 0,
        stylePreset: 'ZETAFROG_CARTOON',
        status: ImageGenerationStatus.PENDING,
      },
    });
  }

  private async updateRecord(id: string, data: any) {
    return prisma.souvenirImage.update({
      where: { id },
      data,
    });
  }
}
```

---

## 6. ç¯å¢ƒé…ç½®

### 6.1 ç¯å¢ƒå˜é‡

```bash
# .env

# ==================== é˜¿é‡Œäº‘ç™¾ç‚¼ ====================
# è·å–æ–¹å¼ï¼šhttps://bailian.console.aliyun.com/ -> API-KEYç®¡ç†
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx

# ==================== IPFS å­˜å‚¨ ====================
# Pinata (æ¨èï¼Œæœ‰å…è´¹é¢åº¦)
PINATA_API_KEY=your_pinata_api_key
PINATA_SECRET_KEY=your_pinata_secret_key

# NFT.Storage (å¤‡ç”¨ï¼Œå…è´¹)
NFT_STORAGE_KEY=your_nft_storage_key

# ==================== æ•°æ®åº“ ====================
DATABASE_URL="postgresql://user:password@localhost:5432/zetafrog"

# ==================== Redis (å¯é€‰ï¼Œç”¨äºé˜Ÿåˆ—) ====================
REDIS_URL="redis://localhost:6379"
```

### 6.2 å®‰è£…ä¾èµ–

```bash
npm install axios sharp form-data
npm install -D @types/sharp
```

---

## 7. API è·¯ç”±

```typescript
// src/routes/nft-image.routes.ts

import { Router } from 'express';
import { NFTImageOrchestratorService } from '../services/nft-image-orchestrator.service';
import { authMiddleware } from '../middleware/auth';

const router = Router();
const orchestrator = new NFTImageOrchestratorService();

/**
 * POST /api/nft-image/generate
 * ç”Ÿæˆçºªå¿µå“å›¾ç‰‡
 */
router.post('/generate', authMiddleware, async (req, res) => {
  try {
    const { odosId, travelId, souvenirId, souvenirType, rarity, chainId } = req.body;

    const result = await orchestrator.generateSouvenirImage({
      odosId,
      travelId,
      souvenirId,
      souvenirType,
      rarity,
      chainId,
    });

    res.json(result);
  } catch (error: any) {
    res.status(500).json({ success: false, error: error.message });
  }
});

/**
 * GET /api/nft-image/status/:souvenirId
 * æŸ¥è¯¢æŸä¸ªçºªå¿µå“çš„ç”ŸæˆçŠ¶æ€
 */
router.get('/status/:souvenirId', async (req, res) => {
  try {
    const { souvenirId } = req.params;

    const record = await prisma.souvenirImage.findFirst({
      where: { souvenirId },
      orderBy: { createdAt: 'desc' },
      select: {
        id: true,
        odosId: true,
        souvenirId: true,
        souvenirType: true,
        rarity: true,
        status: true,
        imageUrl: true,
        ipfsHash: true,
        gatewayUrl: true,
        errorMessage: true,
        createdAt: true,
        generatedAt: true,
        uploadedAt: true,
      },
    });

    if (!record) {
      return res.status(404).json({
        success: false,
        error: 'Generation record for this souvenir not found',
      });
    }

    res.json({
      success: true,
      record,
    });
  } catch (error: any) {
    res.status(500).json({ success: false, error: error.message });
  }
});

export default router;
```

---

## 8. æˆæœ¬è®¡ç®—å™¨

```typescript
// src/utils/cost-calculator.ts

export const COST_CONFIG = {
  // å›¾ç‰‡ç”Ÿæˆæˆæœ¬ï¼ˆå…ƒ/å¼ ï¼‰
  IMAGE_GENERATION: {
    'wan2.2-t2i-flash': 0.04,
    'wan2.2-t2i-plus': 0.08,
    'wan2.5-t2i-preview': 0.10,
    'wanx2.1-t2i-turbo': 0.06,
  },

  // IPFS å­˜å‚¨ï¼ˆä¼°ç®—ï¼‰
  IPFS_STORAGE: {
    freeQuota: 1024 * 1024 * 1024, // 1GB å…è´¹
    pricePerGB: 0.1, // ç¾å…ƒ/GB
  },
};

export function calculateMonthlyCost(
  imageCount: number,
  model: string = 'wan2.2-t2i-flash'
): {
  imageCost: number;
  storageCost: number;
  totalCost: number;
  currency: string;
} {
  const pricePerImage = COST_CONFIG.IMAGE_GENERATION[model] || 0.04;
  const imageCost = imageCount * pricePerImage;

  // å‡è®¾æ¯å¼ å›¾ç‰‡ 300KB
  const totalStorageMB = (imageCount * 300) / 1024;
  const storageCostUSD = totalStorageMB > 1024 
    ? ((totalStorageMB - 1024) / 1024) * COST_CONFIG.IPFS_STORAGE.pricePerGB 
    : 0;
  const storageCost = storageCostUSD * 7.2; // ç¾å…ƒè½¬äººæ°‘å¸

  return {
    imageCost,
    storageCost,
    totalCost: imageCost + storageCost,
    currency: 'CNY',
  };
}

// ç¤ºä¾‹ï¼šè®¡ç®—æ¯æœˆ 10,000 å¼ å›¾ç‰‡çš„æˆæœ¬
// calculateMonthlyCost(10000, 'wan2.2-t2i-flash')
// => { imageCost: 400, storageCost: ~0, totalCost: ~400, currency: 'CNY' }
```

---

## 9. å¼€å‘è®¡åˆ’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¼€å‘è®¡åˆ’ (3-4å¤©)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Day 1: åŸºç¡€è®¾æ–½                                            â”‚
â”‚  â˜ é…ç½®é˜¿é‡Œäº‘ç™¾ç‚¼ API Key                                   â”‚
â”‚  â˜ å®ç° DashScopeImageService                              â”‚
â”‚  â˜ æµ‹è¯•åŸºç¡€å›¾ç‰‡ç”Ÿæˆ                                         â”‚
â”‚  â˜ å®ç° Prompt æ„å»ºç³»ç»Ÿ                                     â”‚
â”‚                                                             â”‚
â”‚  Day 2: æ ¸å¿ƒåŠŸèƒ½                                            â”‚
â”‚  â˜ é…ç½® 9 ç§çºªå¿µå“ Prompt æ¨¡æ¿                              â”‚
â”‚  â˜ å®ç°å›¾ç‰‡å¤„ç†æœåŠ¡                                         â”‚
â”‚  â˜ é…ç½® IPFS å­˜å‚¨                                           â”‚
â”‚  â˜ å®ç°ç¼–æ’æœåŠ¡                                             â”‚
â”‚                                                             â”‚
â”‚  Day 3: é›†æˆæµ‹è¯•                                            â”‚
â”‚  â˜ å®ç° API è·¯ç”±                                            â”‚
â”‚  â˜ ç«¯åˆ°ç«¯æµ‹è¯•æ‰€æœ‰çºªå¿µå“ç±»å‹                                 â”‚
â”‚  â˜ æµ‹è¯•ä¸åŒç¨€æœ‰åº¦æ•ˆæœ                                       â”‚
â”‚  â˜ é”™è¯¯å¤„ç†ä¼˜åŒ–                                             â”‚
â”‚                                                             â”‚
â”‚  Day 4: ä¼˜åŒ–éƒ¨ç½²                                            â”‚
â”‚  â˜ æ·»åŠ å¼‚æ­¥é˜Ÿåˆ—ï¼ˆå¯é€‰ï¼‰                                     â”‚
â”‚  â˜ æ€§èƒ½ä¼˜åŒ–                                                 â”‚
â”‚  â˜ éƒ¨ç½²æµ‹è¯•                                                 â”‚
â”‚  â˜ æ–‡æ¡£å®Œå–„                                                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. æµ‹è¯•ç”¨ä¾‹

### 10.1 å•å…ƒæµ‹è¯•

```typescript
// tests/services/dashscope-image.service.test.ts

import { DashScopeImageService } from '../../src/services/dashscope-image.service';
import { MODEL_CONFIG, SIZE_OPTIONS } from '../../src/services/dashscope-image.service';

describe('DashScopeImageService', () => {
  let service: DashScopeImageService;
  
  beforeEach(() => {
    service = new DashScopeImageService(process.env.DASHSCOPE_API_KEY!);
  });

  describe('createTask', () => {
    it('should create a task successfully', async () => {
      const taskId = await service.createTask({
        prompt: 'A cute frog',
        model: MODEL_CONFIG.FLASH.model,
        size: SIZE_OPTIONS.SQUARE_512,
      });

      expect(taskId).toBeDefined();
      expect(typeof taskId).toBe('string');
    });
  });

  describe('generateImage', () => {
    it('should generate an image successfully', async () => {
      const result = await service.generateImage({
        prompt: 'cute cartoon frog, blockchain theme',
        model: MODEL_CONFIG.FLASH.model,
        size: SIZE_OPTIONS.SQUARE_512,
        prompt_extend: true,
      });

      expect(result.imageUrl).toBeDefined();
      expect(result.imageUrl).toMatch(/^https?:\/\//);
    }, 60000); // 60ç§’è¶…æ—¶
  });
});
```

### 10.2 é›†æˆæµ‹è¯•

```typescript
// tests/integration/nft-image-generation.test.ts

import { NFTImageOrchestratorService } from '../../src/services/nft-image-orchestrator.service';

describe('NFT Image Generation Integration', () => {
  let orchestrator: NFTImageOrchestratorService;

  beforeAll(() => {
    orchestrator = new NFTImageOrchestratorService();
  });

  it('should generate Ethereum postcard souvenir', async () => {
    const result = await orchestrator.generateSouvenirImage({
      odosId: 'test-odos-1',
      travelId: 'test-travel-1',
      souvenirId: 'test-souvenir-1',
      souvenirType: 'ETHEREUM_POSTCARD',
      rarity: 'RARE',
      chainId: 1, // Ethereum
    });

    expect(result.success).toBe(true);
    expect(result.ipfsHash).toBeDefined();
    expect(result.imageUrl).toMatch(/^https:\/\/ipfs.io\/ipfs\//);
  }, 120000); // 2åˆ†é’Ÿè¶…æ—¶

  it('should generate ZetaChain legendary portal', async () => {
    const result = await orchestrator.generateSouvenirImage({
      odosId: 'test-odos-2',
      travelId: 'test-travel-2',
      souvenirId: 'test-souvenir-2',
      souvenirType: 'CROSS_CHAIN_PORTAL',
      rarity: 'LEGENDARY',
      chainId: 7001, // ZetaChain
    });

    expect(result.success).toBe(true);
    expect(result.ipfsHash).toBeDefined();
  }, 120000);
});
```

### 10.3 æ€§èƒ½æµ‹è¯•

```typescript
// tests/performance/load.test.ts

import { DashScopeImageService } from '../../src/services/dashscope-image.service';

describe('Load Testing', () => {
  const service = new DashScopeImageService(process.env.DASHSCOPE_API_KEY!);

  it('should handle 10 concurrent requests', async () => {
    const promises = Array.from({ length: 10 }, (_, i) => 
      service.generateImage({
        prompt: `Test frog ${i}`,
        model: 'wan2.2-t2i-flash',
        size: '512*512',
      })
    );

    const results = await Promise.allSettled(promises);
    
    const successful = results.filter(r => r.status === 'fulfilled').length;
    const failed = results.filter(r => r.status === 'rejected').length;
    
    console.log(`æˆåŠŸ: ${successful}, å¤±è´¥: ${failed}`);
    expect(successful).toBeGreaterThan(5); // è‡³å°‘50%æˆåŠŸ
  }, 300000); // 5åˆ†é’Ÿè¶…æ—¶
});
```

---

## 11. éƒ¨ç½²æŒ‡å—

### 11.1 ç”Ÿäº§ç¯å¢ƒé…ç½®

```bash
# .env.production
NODE_ENV=production

# ä½¿ç”¨é«˜å¹¶å‘é…ç½®
DASHSCOPE_API_KEY=your_production_key
DATABASE_URL=postgresql://user:pass@prod-db:5432/zetafrog
REDIS_URL=redis://prod-redis:6379

# å¯ç”¨ç›‘æ§
LOG_LEVEL=info
METRICS_ENABLED=true
```

### 11.2 Docker éƒ¨ç½²

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆå›¾ç‰‡å¤„ç†ï¼‰
RUN apk add --no-cache \
    cairo-dev \
    jpeg-dev \
    pango-dev \
    musl-dev \
    giflib-dev \
    pixman-dev \
    pangomm-dev \
    libjpeg-turbo-dev \
    freetype-dev

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3001

CMD ["npm", "start"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    environment:
      - NODE_ENV=production
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: zetafrog
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    restart: unless-stopped

volumes:
  postgres_data:
```

### 11.3 ç›‘æ§å’Œæ—¥å¿—

```typescript
// src/utils/monitoring.ts

import { logger } from './logger';

export class ImageGenerationMonitor {
  static trackGeneration(type: string, rarity: string, duration: number) {
    // è®°å½•ç”Ÿæˆæ—¶é—´
    logger.info(`Image generated`, {
      type,
      rarity,
      duration: `${duration}ms`,
    });

    // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    if (process.env.METRICS_ENABLED) {
      // Prometheus metrics
      // metrics.histogram('image_generation_duration', duration, { type, rarity });
    }
  }

  static trackError(type: string, error: Error) {
    logger.error(`Image generation failed`, {
      type,
      error: error.message,
      stack: error.stack,
    });
  }
}
```

---

## 12. æ€»ç»“

### å…³é”®å†³ç­–

| å†³ç­–é¡¹ | é€‰æ‹© | ç†ç”± |
|-------|------|------|
| **AI æ¨¡å‹** | wan2.2-t2i-flash | æœ€å¿«(50%+)ã€æœ€ä¾¿å®œ(Â¥0.04/å¼ ) |
| **å›¾ç‰‡å°ºå¯¸** | 512Ã—512 | NFT æ ‡å‡†å°ºå¯¸ï¼Œæˆæœ¬æœ€ä½ |
| **Prompt ç­–ç•¥** | è‹±æ–‡ + æ™ºèƒ½æ”¹å†™ | æ•ˆæœæ›´å¥½ï¼Œè‡ªåŠ¨æ‰©å±• |
| **å­˜å‚¨æ–¹æ¡ˆ** | IPFS (Pinata) | å»ä¸­å¿ƒåŒ–ï¼Œæ°¸ä¹…å­˜å‚¨ |

### æˆæœ¬åˆ†æ

- **å›¾ç‰‡ç”Ÿæˆ**ï¼šÂ¥0.04/å¼ ï¼ˆflashæ¨¡å‹ï¼‰
- **æœˆåº¦æˆæœ¬**ï¼ˆ10,000å¼ ï¼‰ï¼šçº¦Â¥400
- **å¹´æ€»æˆæœ¬**ï¼šçº¦Â¥5,000ï¼ˆåŒ…å«å­˜å‚¨ï¼‰

### æŠ€æœ¯äº®ç‚¹

1. **å¼‚æ­¥å¤„ç†**ï¼šé¿å…é˜»å¡ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
2. **æ™ºèƒ½Prompt**ï¼šè‡ªåŠ¨æ‰©å±•ï¼Œç¡®ä¿ç”Ÿæˆè´¨é‡
3. **æˆæœ¬ä¼˜åŒ–**ï¼šé€‰æ‹©æœ€ä¼˜æ¨¡å‹ï¼Œæ§åˆ¶æˆæœ¬
4. **é”™è¯¯æ¢å¤**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
5. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒæ·»åŠ æ–°çš„çºªå¿µå“ç±»å‹

### åç»­ä¼˜åŒ–

1. **ç¼“å­˜æœºåˆ¶**ï¼šç›¸ä¼¼Promptå¤ç”¨ç»“æœ
2. **æ‰¹é‡ç”Ÿæˆ**ï¼šé™ä½APIè°ƒç”¨æˆæœ¬
3. **ç”¨æˆ·å®šåˆ¶**ï¼šå…è®¸è‡ªå®šä¹‰Promptå…ƒç´ 
4. **A/Bæµ‹è¯•**ï¼šå¯¹æ¯”ä¸åŒæ¨¡å‹æ•ˆæœ
5. **æœ¬åœ°éƒ¨ç½²**ï¼šè€ƒè™‘Stable Diffusionæœ¬åœ°åŒ–

---

## 13. å¿«é€Ÿå¼€å§‹

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/RSXLX/ZFrog.git
cd ZFrog

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp backend/.env.example backend/.env
# ç¼–è¾‘ backend/.envï¼Œæ·»åŠ  DASHSCOPE_API_KEY

# 3. å®‰è£…ä¾èµ–
cd backend
npm install

# 4. è¿è¡Œæ•°æ®åº“è¿ç§»
npx prisma migrate dev

# 5. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# 6. æµ‹è¯•å›¾ç‰‡ç”Ÿæˆ
curl -X POST http://localhost:3001/api/nft-image/generate \
  -H "Content-Type: application/json" \
  -d '{
    "odosId": "test-1",
    "travelId": "travel-1",
    "souvenirId": "souvenir-1",
    "souvenirType": "ETHEREUM_POSTCARD",
    "rarity": "RARE",
    "chainId": 1
  }'
```

---

## 14. å¸¸è§é—®é¢˜

### Q1: å›¾ç‰‡ç”Ÿæˆå¤±è´¥æ€ä¹ˆåŠï¼Ÿ
A: æ£€æŸ¥API Keyæ˜¯å¦æ­£ç¡®ï¼Œç½‘ç»œæ˜¯å¦æ­£å¸¸ï¼ŒPromptæ˜¯å¦åŒ…å«æ•æ„Ÿè¯ã€‚

### Q2: å¦‚ä½•é™ä½æˆæœ¬ï¼Ÿ
A: ä½¿ç”¨flashæ¨¡å‹ï¼Œæ§åˆ¶ç”Ÿæˆæ•°é‡ï¼Œå¤ç”¨ç›¸ä¼¼Promptç»“æœã€‚

### Q3: IPFS ä¸Šä¼ å¤±è´¥ï¼Ÿ
A: æ£€æŸ¥Pinataé…ç½®ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´ï¼Œé‡è¯•æœºåˆ¶ä¼šè‡ªåŠ¨å¤„ç†ã€‚

### Q4: å¦‚ä½•è‡ªå®šä¹‰çºªå¿µå“ç±»å‹ï¼Ÿ
A: åœ¨ `src/config/prompt-templates.ts` æ·»åŠ æ–°çš„é…ç½®å³å¯ã€‚

---

## 15. è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. å‘èµ· Pull Request

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-12-19  
**ç»´æŠ¤è€…**: ZetaFrog Team

