---
description: 清空青蛙相关数据并重新部署合约的完整重置流程
---

# 重置工作流

> 此工作流用于清空数据库中的所有青蛙相关数据并重新部署合约，适用于开发环境数据混乱需要重新开始的场景。

## 一、停止服务

```bash
# 停止前端和后端服务（Ctrl+C 终止）
# 确保没有进程在访问数据库
```

---

## 二、清空数据库

// turbo
### 2.1 执行完整清理 SQL（保留徽章定义）

```bash
cd c:\Users\94447\Desktop\FROG\backend

echo 'TRUNCATE "Travel", "Souvenir", "Friendship", "FriendInteraction", "Frog" CASCADE;' | npx prisma db execute --stdin
```

> **注意**：`TravelBadge` 表（徽章定义）被保留，可通过 `npx tsx prisma/seeds/seed-all-badges.ts` 重建。

**涉及的表（按依赖顺序）：**
- 旅行系统：Travel, TravelDiscovery, TravelInteraction, TravelFootprint, TravelStatusLog, TravelFeed
- 链上记录：WalletObservation, CrossChainMessage
- 社交系统：Friendship, FriendInteraction, GroupTravel, VisitorMessage, RescueRequest
- 物品系统：Souvenir, FoodInventory, UserDecoration, Gift
- 成就系统：FrogBadge（用户获得的徽章）, EarnedAchievement
- 家园系统：RoomLayout, Photo, DailyTreasure
- 其他：SnackPreference, ExplorationFootprint, AppearanceAsset
- 核心：Frog
- **保留**：TravelBadge（徽章定义，38 个）

---

## 三、重新部署合约

### 3.1 部署全套合约

```bash
cd c:\Users\94447\Desktop\FROG\contracts
npx hardhat run scripts/deploy-upgradeable-all.js --network zetaAthens
```

### 3.2 记录新地址

部署完成后，脚本会输出新的合约地址，需要记录：
- `ZetaFrogNFT (Proxy)`
- `SouvenirNFT`
- `Travel`
- `OmniTravel (Proxy)`

### 3.3 配置合约权限

```bash
npx hardhat run scripts/configure-all-travel.js --network zetaAthens
```

### 3.4 配置跨链支持（重要！）

> ⚠️ **此步骤必须执行**，否则跨链旅行会报错 "Chain not supported"

```bash
npx hardhat run scripts/configure-omnitravel-proxy.js --network zetaAthens
```

此脚本会配置：
- System Router 和 WZETA 地址
- BSC Testnet (chainId: 97) 的 Connector 和 ZRC20
- ETH Sepolia (chainId: 11155111) 的 Connector 和 ZRC20

---

## 四、更新配置文件

### 4.1 更新后端 `.env`

```bash
# 编辑 c:\Users\94447\Desktop\FROG\backend\.env
# 更新以下地址为新部署的合约地址：
ZETAFROG_NFT_ADDRESS=<新地址>
SOUVENIR_NFT_ADDRESS=<新地址>
TRAVEL_CONTRACT_ADDRESS=<新地址>
OMNI_TRAVEL_ADDRESS=<新地址>
```

### 4.2 更新前端 `.env`

```bash
# 编辑 c:\Users\94447\Desktop\FROG\frontend\.env
# 更新以下地址：
VITE_CONTRACT_ADDRESS_NFT=<新地址>
VITE_CONTRACT_ADDRESS_TRAVEL=<新地址>
VITE_CONTRACT_ADDRESS_OMNI=<新地址>
VITE_CONTRACT_ADDRESS_SOUVENIR=<新地址>
```

---

## 五、重启服务

```bash
# 后端
cd c:\Users\94447\Desktop\FROG\backend
npm run dev

# 前端（新终端）
cd c:\Users\94447\Desktop\FROG\frontend
npm run dev
```

---

## 六、验证（全流程测试）

> 使用本地私钥钱包对新合约进行端到端测试。

### 6.1 自动化脚本测试

// turbo
```bash
cd c:\Users\94447\Desktop\FROG\backend
npx tsx scripts/verify-full-flow.ts
```

**脚本执行内容**:
1. ✅ 检查钱包余额与现有 Frog NFT 持有量
2. ✅ 若无 Frog，执行 `mintFrog()` 铸造
3. ✅ 验证数据库同步 (Frog 表记录)
4. ✅ 执行 `startTravel()` 发起旅行
5. ✅ 验证旅行状态 (链上 + 数据库)
6. ✅ (可选) 等待旅行完成并验证 `completeTravel()`

### 6.2 手动 UI 测试

1. 访问前端 `http://localhost:5173`，连接钱包
2. 点击"立即铸造"，验证铸造流程
3. 进入"我的青蛙"，确认青蛙状态为 `Idle`
4. 发起旅行，选择目标链和时长
5. 确认旅行状态更新为 `Traveling`
6. 等待旅行结束，确认获得纪念品/日志

### 6.3 数据库验证

```bash
cd c:\Users\94447\Desktop\FROG\backend
npx prisma studio
```

检查以下表：
- `Frog`: 应有新铸造的记录
- `Travel`: 应有旅行记录（若已发起）

---

## 快速脚本（一键清库）

如果只需要清空数据库而不重新部署合约：

```bash
cd c:\Users\94447\Desktop\FROG\backend
echo 'TRUNCATE "TravelFootprint", "TravelInteraction", "TravelDiscovery", "TravelStatusLog", "WalletObservation", "CrossChainMessage", "GroupTravel", "RescueRequest", "SnackPreference", "ExplorationFootprint", "DailyTreasure", "TravelFeed", "VisitorMessage", "Travel", "Souvenir", "FrogBadge", "Friendship", "FriendInteraction", "FoodInventory", "UserDecoration", "RoomLayout", "Gift", "Photo", "EarnedAchievement", "AppearanceAsset", "Frog" CASCADE;' | npx prisma db execute --stdin
```
